<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExpertCell ‚Äì Gesti√≥n Documental</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<style>
:root{--pri:#1B75BB;--dk:#0D4F80;--lt:#E8F2FA;--bg:#F0F4F8;--card:#fff;--txt:#2D3748;--muted:#718096;--bdr:#E2E8F0;--ok:#2E7D32;--warn:#E65100;--red:#C62828;--oklt:#E8F5E9;--warnlt:#FFF3E0}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--txt)}
.sidebar{position:fixed;left:0;top:0;width:220px;height:100vh;background:linear-gradient(180deg,#082440,var(--dk));padding:20px 10px;color:#fff}
.logo{font-size:18px;font-weight:700;padding:10px;margin-bottom:20px;border-bottom:1px solid rgba(255,255,255,.1)}
.nav-item{display:block;width:100%;padding:12px 16px;margin:4px 0;border:none;background:none;color:rgba(255,255,255,.7);font-size:14px;text-align:left;border-radius:8px;cursor:pointer}
.nav-item:hover,.nav-item.active{background:rgba(255,255,255,.1);color:#fff}
.main{margin-left:220px;padding:24px}
.topbar{background:var(--card);padding:16px 24px;border-radius:10px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.topbar h1{font-size:18px;color:var(--dk)}
.btn{padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}
.btn-pri{background:var(--pri);color:#fff}
.btn-ok{background:var(--ok);color:#fff}
.btn-ghost{background:none;border:2px solid var(--bdr);color:var(--txt)}
.card{background:var(--card);border-radius:10px;padding:20px;margin-bottom:16px;border:1px solid var(--bdr)}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}
.stat{background:var(--card);padding:20px;border-radius:10px;border-left:4px solid var(--pri)}
.stat-num{font-size:32px;font-weight:800;color:var(--dk)}
.stat-label{font-size:12px;color:var(--muted);text-transform:uppercase}
table{width:100%;border-collapse:collapse}
th,td{padding:12px;text-align:left;border-bottom:1px solid var(--bdr)}
th{background:#f8f9fa;font-size:12px;color:var(--muted);text-transform:uppercase}
.badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-weight:600}
.badge-min{background:var(--lt);color:var(--pri)}
.badge-avi{background:var(--warnlt);color:var(--warn)}
.badge-ok{background:var(--oklt);color:var(--ok)}
.badge-pend{background:var(--warnlt);color:var(--warn)}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;font-weight:600;color:var(--dk);margin-bottom:6px;text-transform:uppercase}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:2px solid var(--bdr);border-radius:8px;font-size:14px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--pri);outline:none}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:14px 28px;border-radius:10px;color:#fff;font-weight:600;z-index:1000;display:none}
.toast.ok{background:var(--ok)}.toast.err{background:var(--red)}
.loading{position:fixed;inset:0;background:rgba(255,255,255,.9);display:flex;align-items:center;justify-content:center;z-index:999;font-size:18px;color:var(--dk)}
.hidden{display:none!important}
.actions button{margin-left:8px;padding:6px 12px;font-size:12px}
</style>
</head>
<body>

<div class="loading" id="loading">‚è≥ Cargando datos de Drive...</div>

<nav class="sidebar">
  <div class="logo">üìã ExpertCell</div>
  <button class="nav-item active" onclick="showPage('dashboard')">üìä Dashboard</button>
  <button class="nav-item" onclick="showPage('nuevo')">‚ûï Nuevo Documento</button>
  <button class="nav-item" onclick="showPage('minutas')">üìã Minutas</button>
  <button class="nav-item" onclick="showPage('avisos')">üì¢ Avisos</button>
  <button class="nav-item" onclick="showPage('config')">‚öôÔ∏è Configuraci√≥n</button>
</nav>

<div class="main">
  <div class="topbar">
    <h1 id="page-title">Dashboard</h1>
    <button class="btn btn-pri" onclick="showPage('nuevo')">‚ûï Nuevo Documento</button>
  </div>
  <div id="content"></div>
</div>

<div class="toast" id="toast"></div>

<script>
// CONFIG - TU URL DE APPS SCRIPT
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby6G8R-eL-Q7is-0yqRMQ8mFSP6vhL1KFn6pMp6TEcB77KUeGSlGrTiulOEhKwlmAtw2Q/exec';

let documents = [];
let currentPage = 'dashboard';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê API FUNCTIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromDrive() {
  try {
    const response = await fetch(SCRIPT_URL + '?action=getAll');
    const data = await response.json();
    if (data.success) {
      documents = data.documents || [];
      return true;
    }
  } catch (e) {
    console.error('Error loading:', e);
  }
  return false;
}

async function saveToDrive(doc) {
  try {
    const response = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'save', document: doc })
    });
    return true;
  } catch (e) {
    console.error('Error saving:', e);
    return false;
  }
}

async function deleteFromDrive(id) {
  try {
    await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'delete', id: id })
    });
    return true;
  } catch (e) {
    return false;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê UI HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type = 'ok') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', 3000);
}

function showLoading(show) {
  document.getElementById('loading').classList.toggle('hidden', !show);
}

function genId() {
  return 'DOC-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 4).toUpperCase();
}

function fmtDate(d) {
  if (!d) return '';
  const p = d.split('-');
  return p.length === 3 ? `${p[2]}/${p[1]}/${p[0]}` : d;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NAVIGATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showPage(page) {
  currentPage = page;
  document.querySelectorAll('.nav-item').forEach((b, i) => {
    b.classList.toggle('active', i === ['dashboard', 'nuevo', 'minutas', 'avisos', 'config'].indexOf(page));
  });
  const titles = { dashboard: 'Dashboard', nuevo: 'Nuevo Documento', minutas: 'Minutas', avisos: 'Avisos', config: 'Configuraci√≥n' };
  document.getElementById('page-title').textContent = titles[page] || '';
  
  const renderers = { dashboard: renderDashboard, nuevo: renderNuevo, minutas: () => renderList('minuta'), avisos: () => renderList('aviso'), config: renderConfig };
  (renderers[page] || renderDashboard)();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard() {
  const mins = documents.filter(d => d.type === 'minuta').length;
  const avis = documents.filter(d => d.type === 'aviso').length;
  const firm = documents.filter(d => d.status === 'firmado').length;
  const pend = documents.filter(d => d.status === 'pendiente').length;

  let h = `<div class="stats">
    <div class="stat"><div class="stat-num">${documents.length}</div><div class="stat-label">Total</div></div>
    <div class="stat"><div class="stat-num">${mins}</div><div class="stat-label">Minutas</div></div>
    <div class="stat"><div class="stat-num">${firm}</div><div class="stat-label">Firmados</div></div>
    <div class="stat"><div class="stat-num">${pend}</div><div class="stat-label">Pendientes</div></div>
  </div>`;

  h += '<div class="card"><h3 style="margin-bottom:16px">üìÑ Documentos Recientes</h3>';
  if (documents.length === 0) {
    h += '<p style="color:var(--muted);text-align:center;padding:40px">No hay documentos. Crea uno nuevo.</p>';
  } else {
    h += '<table><thead><tr><th>Folio</th><th>Tipo</th><th>T√≠tulo</th><th>Fecha</th><th>Estatus</th><th>Acciones</th></tr></thead><tbody>';
    documents.slice().sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)).slice(0, 10).forEach(d => {
      const typeB = d.type === 'minuta' ? 'badge-min' : 'badge-avi';
      const typeN = d.type === 'minuta' ? 'Minuta' : 'Aviso';
      const statB = d.status === 'firmado' ? 'badge-ok' : 'badge-pend';
      const statN = d.status === 'firmado' ? 'Firmado' : 'Pendiente';
      h += `<tr>
        <td><strong>${d.folio || '‚Äî'}</strong></td>
        <td><span class="badge ${typeB}">${typeN}</span></td>
        <td>${d.title || '‚Äî'}</td>
        <td>${d.displayDate || '‚Äî'}</td>
        <td><span class="badge ${statB}">${statN}</span></td>
        <td class="actions">
          <button class="btn btn-ghost" onclick="downloadPDF('${d.id}')">üìï PDF</button>
          <button class="btn btn-ghost" onclick="deleteDoc('${d.id}')">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    h += '</tbody></table>';
  }
  h += '</div>';
  document.getElementById('content').innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIST VIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderList(type) {
  const docs = documents.filter(d => d.type === type).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
  const typeName = type === 'minuta' ? 'Minutas' : 'Avisos';

  let h = '<div class="card">';
  if (docs.length === 0) {
    h += `<p style="color:var(--muted);text-align:center;padding:40px">No hay ${typeName.toLowerCase()} registrados.</p>`;
  } else {
    h += '<table><thead><tr><th>Folio</th><th>T√≠tulo</th><th>Fecha</th><th>Estatus</th><th>Acciones</th></tr></thead><tbody>';
    docs.forEach(d => {
      const statB = d.status === 'firmado' ? 'badge-ok' : 'badge-pend';
      const statN = d.status === 'firmado' ? 'Firmado' : 'Pendiente';
      h += `<tr>
        <td><strong>${d.folio || '‚Äî'}</strong></td>
        <td>${d.title || '‚Äî'}</td>
        <td>${d.displayDate || '‚Äî'}</td>
        <td><span class="badge ${statB}">${statN}</span></td>
        <td class="actions">
          <button class="btn btn-ghost" onclick="downloadPDF('${d.id}')">üìï PDF</button>
          <button class="btn btn-ghost" onclick="toggleStatus('${d.id}')">${d.status === 'firmado' ? '‚è≥' : '‚úÖ'}</button>
          <button class="btn btn-ghost" onclick="deleteDoc('${d.id}')">üóëÔ∏è</button>
        </td>
      </tr>`;
    });
    h += '</tbody></table>';
  }
  h += '</div>';
  document.getElementById('content').innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NEW DOCUMENT FORM ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let docType = 'minuta';

function renderNuevo() {
  const folioMin = 'EC-MIN-' + String(documents.filter(d => d.type === 'minuta').length + 1).padStart(3, '0');
  const folioAvi = 'EC-AVI-' + String(documents.filter(d => d.type === 'aviso').length + 1).padStart(3, '0');

  let h = `<div class="card">
    <div style="display:flex;gap:10px;margin-bottom:20px">
      <button class="btn ${docType === 'minuta' ? 'btn-pri' : 'btn-ghost'}" onclick="docType='minuta';renderNuevo()">üìã Minuta</button>
      <button class="btn ${docType === 'aviso' ? 'btn-pri' : 'btn-ghost'}" onclick="docType='aviso';renderNuevo()">üì¢ Aviso</button>
    </div>`;

  if (docType === 'minuta') {
    h += `<div class="grid-2">
      <div class="form-group"><label>Folio</label><input id="f-folio" value="${folioMin}"></div>
      <div class="form-group"><label>Tipo Reuni√≥n</label><select id="f-tipo"><option>Ordinaria</option><option>Extraordinaria</option><option>Seguimiento</option></select></div>
      <div class="form-group"><label>Fecha *</label><input type="date" id="f-fecha"></div>
      <div class="form-group"><label>Ubicaci√≥n</label><input id="f-ubic" value="Sala de juntas ‚Äì Torre JV"></div>
      <div class="form-group"><label>Hora Inicio</label><input type="time" id="f-hinicio"></div>
      <div class="form-group"><label>Hora Fin</label><input type="time" id="f-hfin"></div>
      <div class="form-group"><label>Convocada por *</label><input id="f-convoca" placeholder="Nombre"></div>
      <div class="form-group"><label>Elabora</label><input id="f-elabora"></div>
    </div>
    <div class="form-group"><label>Objetivo</label><textarea id="f-objetivo" rows="2"></textarea></div>
    <div class="form-group"><label>Observaciones</label><textarea id="f-obs" rows="3"></textarea></div>`;
  } else {
    h += `<div class="grid-2">
      <div class="form-group"><label>Folio</label><input id="f-afolio" value="${folioAvi}"></div>
      <div class="form-group"><label>Tipo</label><select id="f-atipo"><option>Informativo</option><option>Cambio operativo</option><option>Pol√≠tica</option><option>Urgente</option></select></div>
      <div class="form-group"><label>Fecha *</label><input type="date" id="f-afecha"></div>
      <div class="form-group"><label>Vigencia</label><input id="f-avig"></div>
      <div class="form-group"><label>Emitido por *</label><input id="f-aemit"></div>
      <div class="form-group"><label>Dirigido a</label><input id="f-adir" value="Todo el personal"></div>
    </div>
    <div class="form-group"><label>Asunto *</label><input id="f-aasunto"></div>
    <div class="form-group"><label>Contenido</label><textarea id="f-acont" rows="4"></textarea></div>`;
  }

  h += `<div style="margin-top:24px;display:flex;gap:12px;justify-content:center">
    <button class="btn btn-pri" onclick="saveDoc('pdf')">üìï Guardar y PDF</button>
    <button class="btn btn-ok" onclick="saveDoc('save')">üíæ Solo Guardar</button>
  </div></div>`;

  document.getElementById('content').innerHTML = h;
}

async function saveDoc(mode) {
  showLoading(true);
  
  let doc;
  if (docType === 'minuta') {
    const fecha = document.getElementById('f-fecha').value;
    doc = {
      id: genId(),
      type: 'minuta',
      folio: document.getElementById('f-folio').value,
      title: 'Minuta ' + document.getElementById('f-tipo').value + ' ‚Äì ' + fmtDate(fecha),
      displayDate: fmtDate(fecha),
      status: 'pendiente',
      createdAt: Date.now(),
      data: {
        tipo: document.getElementById('f-tipo').value,
        fecha: fecha,
        hinicio: document.getElementById('f-hinicio').value,
        hfin: document.getElementById('f-hfin').value,
        ubicacion: document.getElementById('f-ubic').value,
        convoca: document.getElementById('f-convoca').value,
        elabora: document.getElementById('f-elabora').value,
        objetivo: document.getElementById('f-objetivo').value,
        observaciones: document.getElementById('f-obs').value
      }
    };
  } else {
    const fecha = document.getElementById('f-afecha').value;
    doc = {
      id: genId(),
      type: 'aviso',
      folio: document.getElementById('f-afolio').value,
      title: document.getElementById('f-aasunto').value || 'Aviso',
      displayDate: fmtDate(fecha),
      status: 'pendiente',
      createdAt: Date.now(),
      data: {
        tipo: document.getElementById('f-atipo').value,
        fecha: fecha,
        vigencia: document.getElementById('f-avig').value,
        emitido: document.getElementById('f-aemit').value,
        dirigido: document.getElementById('f-adir').value,
        asunto: document.getElementById('f-aasunto').value,
        contenido: document.getElementById('f-acont').value
      }
    };
  }

  await saveToDrive(doc);
  documents.push(doc);
  
  showLoading(false);
  
  if (mode === 'pdf') {
    generatePDF(doc);
  }
  
  toast('‚úÖ Documento guardado en Drive');
  setTimeout(() => showPage('dashboard'), 500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DELETE & TOGGLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function deleteDoc(id) {
  if (!confirm('¬øEliminar este documento?')) return;
  showLoading(true);
  await deleteFromDrive(id);
  documents = documents.filter(d => d.id !== id);
  showLoading(false);
  toast('üóëÔ∏è Eliminado');
  showPage(currentPage);
}

async function toggleStatus(id) {
  const doc = documents.find(d => d.id === id);
  if (doc) {
    doc.status = doc.status === 'firmado' ? 'pendiente' : 'firmado';
    showLoading(true);
    await saveToDrive(doc);
    showLoading(false);
    toast(doc.status === 'firmado' ? '‚úÖ Marcado como firmado' : '‚è≥ Marcado como pendiente');
    showPage(currentPage);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONFIG PAGE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderConfig() {
  let h = `<div class="card">
    <h3 style="margin-bottom:16px">‚öôÔ∏è Configuraci√≥n</h3>
    <p><strong>URL Apps Script:</strong></p>
    <p style="font-size:12px;word-break:break-all;color:var(--muted);margin:8px 0">${SCRIPT_URL}</p>
    <p style="margin-top:16px"><strong>Estado:</strong> ‚úÖ Conectado</p>
    <p style="margin-top:8px"><strong>Documentos en Drive:</strong> ${documents.length}</p>
    <button class="btn btn-pri" style="margin-top:16px" onclick="location.reload()">üîÑ Recargar datos</button>
  </div>`;
  document.getElementById('content').innerHTML = h;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PDF GENERATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function downloadPDF(id) {
  const doc = documents.find(d => d.id === id);
  if (doc) generatePDF(doc);
}

function generatePDF(d) {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'mm', 'letter');
  const w = 215.9, m = 20;
  let y = 20;

  // Header
  pdf.setFillColor(13, 79, 128);
  pdf.rect(0, 0, w, 25, 'F');
  pdf.setTextColor(255);
  pdf.setFontSize(16);
  pdf.setFont('helvetica', 'bold');
  pdf.text('ExpertCell', m, 16);
  pdf.setFontSize(10);
  pdf.setFont('helvetica', 'normal');
  pdf.text('Distribuidor Autorizado AT&T', w - m, 16, { align: 'right' });

  y = 35;
  const dd = d.data || {};

  if (d.type === 'minuta') {
    pdf.setTextColor(13, 79, 128);
    pdf.setFontSize(18);
    pdf.setFont('helvetica', 'bold');
    pdf.text('MINUTA DE REUNI√ìN', w / 2, y, { align: 'center' });
    y += 8;
    pdf.setFontSize(11);
    pdf.setTextColor(100);
    pdf.setFont('helvetica', 'normal');
    pdf.text(`${dd.tipo || ''} | Folio: ${d.folio || ''}`, w / 2, y, { align: 'center' });
    y += 12;

    pdf.autoTable({
      startY: y,
      margin: { left: m, right: m },
      theme: 'grid',
      headStyles: { fillColor: [13, 79, 128] },
      body: [
        ['Fecha:', fmtDate(dd.fecha) || '‚Äî', 'Horario:', `${dd.hinicio || '‚Äî'} - ${dd.hfin || '‚Äî'}`],
        ['Ubicaci√≥n:', dd.ubicacion || '‚Äî', 'Convoca:', dd.convoca || '‚Äî'],
        ['Objetivo:', { content: dd.objetivo || '‚Äî', colSpan: 3 }]
      ]
    });
    y = pdf.lastAutoTable.finalY + 10;

    if (dd.observaciones) {
      pdf.setFontSize(12);
      pdf.setTextColor(13, 79, 128);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Observaciones:', m, y);
      y += 6;
      pdf.setFontSize(10);
      pdf.setTextColor(60);
      pdf.setFont('helvetica', 'normal');
      const lines = pdf.splitTextToSize(dd.observaciones, w - m * 2);
      pdf.text(lines, m, y);
      y += lines.length * 5 + 10;
    }
  } else {
    pdf.setFillColor(13, 79, 128);
    pdf.roundedRect(m, y, w - m * 2, 20, 3, 3, 'F');
    pdf.setTextColor(255);
    pdf.setFontSize(16);
    pdf.setFont('helvetica', 'bold');
    pdf.text('AVISO INTERNO', w / 2, y + 13, { align: 'center' });
    y += 30;

    pdf.autoTable({
      startY: y,
      margin: { left: m, right: m },
      theme: 'grid',
      headStyles: { fillColor: [13, 79, 128] },
      columnStyles: { 0: { cellWidth: 40, fillColor: [232, 242, 250], fontStyle: 'bold' } },
      body: [
        ['Folio:', d.folio || ''],
        ['Fecha:', fmtDate(dd.fecha) || '‚Äî'],
        ['Tipo:', dd.tipo || ''],
        ['Emitido por:', dd.emitido || '‚Äî'],
        ['Dirigido a:', dd.dirigido || '‚Äî']
      ]
    });
    y = pdf.lastAutoTable.finalY + 10;

    if (dd.asunto) {
      pdf.setFontSize(12);
      pdf.setTextColor(13, 79, 128);
      pdf.setFont('helvetica', 'bold');
      pdf.text('Asunto: ' + dd.asunto, m, y);
      y += 10;
    }

    if (dd.contenido) {
      pdf.setFontSize(10);
      pdf.setTextColor(60);
      pdf.setFont('helvetica', 'normal');
      const lines = pdf.splitTextToSize(dd.contenido, w - m * 2);
      pdf.text(lines, m, y);
    }
  }

  // Footer
  pdf.setFontSize(8);
  pdf.setTextColor(150);
  pdf.text(`ExpertCell | ${d.folio || ''} | Generado: ${new Date().toLocaleString('es-MX')}`, w / 2, 270, { align: 'center' });

  pdf.save(`${d.folio || 'documento'}_ExpertCell.pdf`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  showLoading(true);
  await loadFromDrive();
  showLoading(false);
  showPage('dashboard');
}

init();
</script>
</body>
</html>
