<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ExpertCell â€“ Sistema de GestiÃ³n Documental</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --pri:#1B75BB;--dk:#0D4F80;--lt:#E8F2FA;--acc:#2E8BC0;--bg:#F0F4F8;
  --card:#fff;--txt:#2D3748;--muted:#718096;--bdr:#E2E8F0;
  --ok:#2E7D32;--warn:#E65100;--red:#C62828;--oklt:#E8F5E9;--warnlt:#FFF3E0;--redlt:#FFEBEE;
  --radius:10px;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh}
::-webkit-scrollbar{width:5px}::-webkit-scrollbar-thumb{background:#c0cdd8;border-radius:3px}
button{font-family:inherit;cursor:pointer}
input,select,textarea{font-family:inherit}

/* â•â•â• SIDEBAR â•â•â• */
.sidebar{position:fixed;left:0;top:0;width:230px;height:100vh;background:linear-gradient(180deg,#082440 0%,var(--dk) 100%);z-index:100;display:flex;flex-direction:column;transition:.3s}
.sb-logo{padding:22px 20px 18px;border-bottom:1px solid rgba(255,255,255,.08)}
.sb-logo svg{display:block}
.sb-nav{flex:1;padding:14px 10px;overflow-y:auto}
.sb-item{display:flex;align-items:center;gap:10px;padding:10px 14px;border-radius:8px;color:rgba(255,255,255,.6);font-size:13px;font-weight:600;cursor:pointer;transition:.2s;margin-bottom:2px;border:none;background:none;width:100%;text-align:left}
.sb-item:hover{background:rgba(255,255,255,.06);color:rgba(255,255,255,.85)}
.sb-item.active{background:rgba(27,117,187,.3);color:#fff}
.sb-item .icon{font-size:17px;width:24px;text-align:center}
.sb-badge{margin-left:auto;background:var(--pri);color:#fff;font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px}
.sb-section{font-size:10px;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1px;padding:16px 14px 6px;font-weight:700}
.sb-footer{padding:14px 16px;border-top:1px solid rgba(255,255,255,.08);font-size:10px;color:rgba(255,255,255,.25);text-align:center}

/* â•â•â• MAIN â•â•â• */
.main{margin-left:230px;min-height:100vh}
.topbar{background:var(--card);border-bottom:1px solid var(--bdr);padding:14px 28px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:50}
.topbar h1{font-size:17px;color:var(--dk);font-weight:700}
.topbar .actions{display:flex;gap:8px;align-items:center}
.content{padding:24px 28px}

/* â•â•â• BUTTONS â•â•â• */
.btn{padding:9px 18px;border-radius:8px;border:none;font-size:13px;font-weight:600;transition:.2s;display:inline-flex;align-items:center;gap:7px}
.btn:hover{transform:translateY(-1px)}
.btn-pri{background:linear-gradient(135deg,var(--dk),var(--pri));color:#fff;box-shadow:0 2px 8px rgba(13,79,128,.25)}
.btn-ok{background:var(--ok);color:#fff}
.btn-warn{background:var(--warn);color:#fff}
.btn-ghost{background:none;border:1.5px solid var(--bdr);color:var(--txt)}
.btn-ghost:hover{border-color:var(--pri);color:var(--pri)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:6px}
.btn-red{background:var(--red);color:#fff}
.btn-danger-ghost{background:none;border:1.5px solid var(--red);color:var(--red);padding:6px 12px;font-size:12px;border-radius:6px}

/* â•â•â• STATS CARDS â•â•â• */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border-radius:var(--radius);padding:18px 20px;border:1px solid var(--bdr);position:relative;overflow:hidden}
.stat-card::after{content:'';position:absolute;top:0;left:0;width:4px;height:100%}
.stat-card.blue::after{background:var(--pri)}.stat-card.green::after{background:var(--ok)}
.stat-card.orange::after{background:var(--warn)}.stat-card.red::after{background:var(--red)}
.stat-num{font-size:28px;font-weight:800;color:var(--dk);line-height:1}
.stat-label{font-size:11px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-top:4px}

/* â•â•â• TABLE â•â•â• */
.table-wrap{background:var(--card);border-radius:var(--radius);border:1px solid var(--bdr);overflow:hidden}
.table-toolbar{padding:14px 18px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--bdr);flex-wrap:wrap}
.search-box{padding:8px 14px;border:1.5px solid var(--bdr);border-radius:8px;font-size:13px;width:240px;outline:none;transition:border .2s}
.search-box:focus{border-color:var(--pri)}
.filter-sel{padding:8px 12px;border:1.5px solid var(--bdr);border-radius:8px;font-size:13px;outline:none;background:#fff}
table.data-tbl{width:100%;border-collapse:collapse}
table.data-tbl th{padding:10px 14px;text-align:left;font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;background:#FAFBFC;border-bottom:1px solid var(--bdr)}
table.data-tbl td{padding:10px 14px;font-size:13px;border-bottom:1px solid var(--bdr);vertical-align:middle}
table.data-tbl tr:hover td{background:#F7FAFC}
.badge{display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:600}
.badge-minuta{background:var(--lt);color:var(--pri)}
.badge-aviso{background:var(--warnlt);color:var(--warn)}
.badge-ret{background:#E8F5E9;color:#2E7D32}
.badge-pln{background:#E3F2FD;color:#1565C0}
.badge-acta{background:#FFEBEE;color:#C62828}
.badge-baja{background:#F3E5F5;color:#7B1FA2}
.badge-firmado{background:var(--oklt);color:var(--ok)}
.badge-pendiente{background:var(--warnlt);color:var(--warn)}
.badge-borrador{background:#F1F1F1;color:#888}
.evidence-indicator{display:inline-flex;align-items:center;gap:4px;font-size:11px;font-weight:600}
.evidence-yes{color:var(--ok)}.evidence-no{color:var(--muted)}

/* â•â•â• MODAL â•â•â• */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:200;display:flex;align-items:flex-start;justify-content:center;padding:30px 20px;overflow-y:auto}
.modal{background:var(--card);border-radius:14px;width:100%;max-width:820px;box-shadow:0 20px 60px rgba(0,0,0,.2);animation:modalIn .3s ease}
@keyframes modalIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.modal-hdr{padding:18px 24px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between}
.modal-hdr h2{font-size:16px;color:var(--dk);font-weight:700}
.modal-close{background:none;border:none;font-size:22px;color:var(--muted);cursor:pointer;padding:4px}
.modal-body{padding:20px 24px;max-height:70vh;overflow-y:auto}
.modal-footer{padding:14px 24px;border-top:1px solid var(--bdr);display:flex;gap:10px;justify-content:flex-end}

/* â•â•â• FORM ELEMENTS â•â•â• */
.fg{margin-bottom:13px}
.fg label{display:block;font-size:11px;font-weight:700;color:var(--dk);margin-bottom:4px;text-transform:uppercase;letter-spacing:.4px}
.fg label .req{color:var(--red)}
.fg input,.fg select,.fg textarea{width:100%;padding:9px 13px;border:1.5px solid var(--bdr);border-radius:8px;font-size:13px;color:var(--txt);outline:none;transition:border .2s;background:#fff}
.fg input:focus,.fg select:focus,.fg textarea:focus{border-color:var(--pri)}
.fg textarea{resize:vertical}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:0 14px}
.sec-title{font-size:13px;font-weight:700;color:var(--pri);padding:10px 0 8px;border-bottom:1px solid var(--bdr);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.mini-tbl{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:8px}
.mini-tbl th{padding:6px 8px;background:var(--lt);color:var(--dk);font-weight:700;font-size:10px;text-transform:uppercase;border:1px solid var(--bdr);text-align:left}
.mini-tbl td{padding:3px;border:1px solid var(--bdr)}
.mini-tbl input,.mini-tbl select{width:100%;padding:5px 7px;border:none;background:transparent;font-size:12px;outline:none;font-family:inherit;box-sizing:border-box}
.btn-add-row{padding:4px 12px;background:none;border:1.5px dashed var(--pri);border-radius:5px;color:var(--pri);font-size:11px;font-weight:600;cursor:pointer;margin-top:4px}

/* â•â•â• UPLOAD ZONE â•â•â• */
.upload-zone{border:2px dashed var(--bdr);border-radius:10px;padding:24px;text-align:center;cursor:pointer;transition:.2s;background:#FAFBFC}
.upload-zone:hover{border-color:var(--pri);background:var(--lt)}
.upload-zone.dragover{border-color:var(--pri);background:var(--lt)}
.upload-icon{font-size:32px;margin-bottom:6px}
.upload-text{font-size:13px;color:var(--muted);font-weight:500}
.upload-text b{color:var(--pri)}
.file-preview{display:flex;align-items:center;gap:12px;padding:10px 14px;background:#FAFBFC;border-radius:8px;border:1px solid var(--bdr);margin-top:8px}
.file-preview img{width:60px;height:60px;object-fit:cover;border-radius:6px;border:1px solid var(--bdr)}
.file-preview .info{flex:1}
.file-preview .info .name{font-size:12px;font-weight:600;color:var(--txt)}
.file-preview .info .size{font-size:11px;color:var(--muted)}

/* â•â•â• DETAIL VIEW â•â•â• */
.detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.detail-section{background:#FAFBFC;border-radius:8px;padding:14px 16px;border:1px solid var(--bdr)}
.detail-section h3{font-size:12px;font-weight:700;color:var(--pri);text-transform:uppercase;letter-spacing:.4px;margin-bottom:10px}
.detail-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid #f0f0f0}
.detail-row:last-child{border-bottom:none}
.detail-row .dl{color:var(--muted);font-weight:600}.detail-row .dv{color:var(--txt);font-weight:500;text-align:right}
.evidence-img{width:100%;max-height:300px;object-fit:contain;border-radius:8px;border:1px solid var(--bdr);margin-top:8px}

/* â•â•â• DRIVE CONFIG â•â•â• */
.config-box{background:var(--lt);border:1px solid rgba(27,117,187,.2);border-radius:10px;padding:18px 20px;margin-bottom:16px}
.config-box h3{font-size:14px;color:var(--dk);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.config-box p{font-size:12px;color:var(--muted);line-height:1.5;margin-bottom:10px}
.config-status{display:flex;align-items:center;gap:8px;padding:8px 14px;border-radius:8px;font-size:12px;font-weight:600}
.config-status.connected{background:var(--oklt);color:var(--ok)}
.config-status.disconnected{background:#F1F1F1;color:#888}

/* â•â•â• EMPTY STATE â•â•â• */
.empty-state{text-align:center;padding:50px 20px}
.empty-state .icon{font-size:48px;margin-bottom:12px}
.empty-state h3{font-size:16px;color:var(--dk);margin-bottom:6px}
.empty-state p{font-size:13px;color:var(--muted);margin-bottom:16px}

/* â•â•â• TOAST â•â•â• */
.toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:12px 24px;border-radius:10px;font-weight:600;font-size:14px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:999;animation:slideUp .35s ease;color:#fff}
.toast.ok{background:var(--ok)}.toast.err{background:var(--red)}.toast.info{background:var(--pri)}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(16px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* â•â•â• RESPONSIVE â•â•â• */
@media(max-width:900px){
  .sidebar{width:60px}.sidebar .sb-item span:not(.icon),.sb-section,.sb-footer,.sb-badge{display:none}
  .sb-logo svg{width:30px !important;overflow:hidden}
  .main{margin-left:60px}
  .stats{grid-template-columns:1fr 1fr}.detail-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- â•â•â• SIDEBAR â•â•â• -->
<nav class="sidebar">
  <div class="sb-logo">
    <svg viewBox="0 0 180 40" width="150" height="34" fill="none">
      <circle cx="18" cy="20" r="14" stroke="#fff" stroke-width="1.8" fill="none" opacity=".7"/>
      <ellipse cx="18" cy="20" rx="7.5" ry="14" stroke="#fff" stroke-width="1.4" fill="none" opacity=".5" transform="rotate(30 18 20)"/>
      <ellipse cx="18" cy="20" rx="7.5" ry="14" stroke="#fff" stroke-width="1.4" fill="none" opacity=".5" transform="rotate(-30 18 20)"/>
      <line x1="4" y1="20" x2="32" y2="20" stroke="#fff" stroke-width="1.4" opacity=".6"/>
      <text x="40" y="26" font-family="DM Sans" font-size="19" font-weight="700" fill="#fff" letter-spacing=".3">ExpertCell</text>
    </svg>
  </div>
  <div class="sb-nav">
    <div class="sb-section">Principal</div>
    <button class="sb-item active" onclick="showPage('dashboard')"><span class="icon">ğŸ“Š</span><span>Dashboard</span></button>
    <button class="sb-item" onclick="showPage('nuevo')"><span class="icon">â•</span><span>Nuevo Documento</span></button>
    <div class="sb-section">Historial</div>
    <button class="sb-item" onclick="showPage('minutas')"><span class="icon">ğŸ“‹</span><span>Minutas</span><span class="sb-badge" id="badge-min">0</span></button>
    <button class="sb-item" onclick="showPage('avisos')"><span class="icon">ğŸ“¢</span><span>Avisos</span><span class="sb-badge" id="badge-avi">0</span></button>
    <button class="sb-item" onclick="showPage('retroalimentaciones')"><span class="icon">ğŸ’¬</span><span>Retroalim.</span><span class="sb-badge" id="badge-ret">0</span></button>
    <button class="sb-item" onclick="showPage('planes')"><span class="icon">ğŸ“Š</span><span>Planes</span><span class="sb-badge" id="badge-pln">0</span></button>
    <button class="sb-item" onclick="showPage('actas')"><span class="icon">âš ï¸</span><span>Actas</span><span class="sb-badge" id="badge-act">0</span></button>
    <button class="sb-item" onclick="showPage('bajas')"><span class="icon">ğŸšª</span><span>Bajas</span><span class="sb-badge" id="badge-baj">0</span></button>
    <div class="sb-section">Sistema</div>
    <button class="sb-item" onclick="showPage('drive')"><span class="icon">â˜ï¸</span><span>Google Drive</span></button>
  </div>
  <div class="sb-footer">ExpertCell Â© 2026<br>Distribuidor Autorizado AT&T</div>
</nav>

<!-- â•â•â• MAIN â•â•â• -->
<div class="main">
  <div class="topbar">
    <h1 id="page-title">Dashboard</h1>
    <div class="actions">
      <button class="btn btn-pri" onclick="showPage('nuevo')">â• Nuevo Documento</button>
    </div>
  </div>
  <div class="content" id="page-content"></div>
</div>

<!-- â•â•â• TOAST â•â•â• -->
<div id="toast" class="toast ok" style="display:none"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATA STORE (localStorage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'ec_docs_v2';
function loadDocs(){ try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||[];}catch(e){return[];} }
function saveDocs(docs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(docs)); }
function genId(){ return 'DOC-'+Date.now().toString(36).toUpperCase()+Math.random().toString(36).substr(2,4).toUpperCase(); }

const DRIVE_KEY = 'ec_drive_config';
function loadDriveConfig(){ try{return JSON.parse(localStorage.getItem(DRIVE_KEY))||{url:'https://script.google.com/macros/s/AKfycby6G8R-eL-Q7is-0yqRMQ8mFSP6vhL1KFn6pMp6TEcB77KUeGSlGrTiulOEhKwlmAtw2Q/exec',connected:true};}catch(e){return{url:'https://script.google.com/macros/s/AKfycby6G8R-eL-Q7is-0yqRMQ8mFSP6vhL1KFn6pMp6TEcB77KUeGSlGrTiulOEhKwlmAtw2Q/exec',connected:true};} }
function saveDriveConfig(cfg){ localStorage.setItem(DRIVE_KEY, JSON.stringify(cfg)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg, type='ok'){
  const t=document.getElementById('toast');
  t.className='toast '+type; t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none',3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPage = 'dashboard';
function showPage(page){
  currentPage = page;
  document.querySelectorAll('.sb-item').forEach(b=>b.classList.remove('active'));
  const labels = {dashboard:'Dashboard',nuevo:'Nuevo Documento',minutas:'Minutas',avisos:'Avisos',retroalimentaciones:'Retroalimentaciones',planes:'Planes de Trabajo',actas:'Actas Administrativas',bajas:'Bajas',drive:'ConfiguraciÃ³n Google Drive'};
  document.getElementById('page-title').textContent = labels[page]||'';
  const navMap = {dashboard:0,nuevo:1,minutas:2,avisos:3,retroalimentaciones:4,planes:5,actas:6,bajas:7,drive:8};
  if(navMap[page]!==undefined) document.querySelectorAll('.sb-item')[navMap[page]]?.classList.add('active');
  updateBadges();
  const renderers = {dashboard:renderDashboard,nuevo:renderNuevo,minutas:()=>renderHistorial('minuta'),avisos:()=>renderHistorial('aviso'),retroalimentaciones:()=>renderHistorial('retroalimentacion'),planes:()=>renderHistorial('plantrabajo'),actas:()=>renderHistorial('actaadmin'),bajas:()=>renderHistorial('baja'),drive:renderDrive};
  (renderers[page]||renderDashboard)();
}

function updateBadges(){
  const docs=loadDocs();
  document.getElementById('badge-min').textContent=docs.filter(d=>d.type==='minuta').length;
  document.getElementById('badge-avi').textContent=docs.filter(d=>d.type==='aviso').length;
  document.getElementById('badge-ret').textContent=docs.filter(d=>d.type==='retroalimentacion').length;
  document.getElementById('badge-pln').textContent=docs.filter(d=>d.type==='plantrabajo').length;
  document.getElementById('badge-act').textContent=docs.filter(d=>d.type==='actaadmin').length;
  document.getElementById('badge-baj').textContent=docs.filter(d=>d.type==='baja').length;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const docs=loadDocs();
  const minutas=docs.filter(d=>d.type==='minuta');
  const avisos=docs.filter(d=>d.type==='aviso');
  const firmados=docs.filter(d=>d.status==='firmado');
  const pendientes=docs.filter(d=>d.status==='pendiente');

  let h=`<div class="stats">
    <div class="stat-card blue"><div class="stat-num">${docs.length}</div><div class="stat-label">Total documentos</div></div>
    <div class="stat-card blue"><div class="stat-num">${minutas.length}</div><div class="stat-label">Minutas</div></div>
    <div class="stat-card green"><div class="stat-num">${firmados.length}</div><div class="stat-label">Firmados</div></div>
    <div class="stat-card orange"><div class="stat-num">${pendientes.length}</div><div class="stat-label">Pendientes de firma</div></div>
  </div>`;

  // Recent docs
  h+='<div class="table-wrap">';
  h+='<div class="table-toolbar"><span style="font-weight:700;font-size:14px;color:var(--dk)">ğŸ“„ Documentos Recientes</span><div style="margin-left:auto"><button class="btn btn-pri btn-sm" onclick="showPage(\'nuevo\')">â• Nuevo</button></div></div>';

  if(docs.length===0){
    h+=`<div class="empty-state"><div class="icon">ğŸ“‚</div><h3>Sin documentos aÃºn</h3><p>Crea tu primera minuta o aviso para comenzar.</p><button class="btn btn-pri" onclick="showPage('nuevo')">â• Crear documento</button></div>`;
  } else {
    const recent = docs.slice().sort((a,b)=>b.createdAt-a.createdAt).slice(0,8);
    h+=`<table class="data-tbl"><thead><tr><th>Folio</th><th>Tipo</th><th>TÃ­tulo</th><th>Fecha</th><th>Estatus</th><th>Evidencia</th><th>Acciones</th></tr></thead><tbody>`;
    recent.forEach(d=>{
      const typeNames = {minuta:'Minuta',aviso:'Aviso',retroalimentacion:'Retroalim.',plantrabajo:'Plan Trabajo',actaadmin:'Acta Admin.',baja:'Baja'};
      const typeClasses = {minuta:'badge-minuta',aviso:'badge-aviso',retroalimentacion:'badge-ret',plantrabajo:'badge-pln',actaadmin:'badge-acta',baja:'badge-baja'};
      const typeClass = typeClasses[d.type]||'badge-aviso';
      const typeName = typeNames[d.type]||d.type;
      const statusClass = d.status==='firmado'?'badge-firmado':d.status==='pendiente'?'badge-pendiente':'badge-borrador';
      const evid = (d.evidence||d.evidenceUrl)?`<span class="evidence-indicator evidence-yes">âœ… SÃ­</span>`:`<span class="evidence-indicator evidence-no">â€” No</span>`;
      h+=`<tr>
        <td><strong>${d.folio||'â€”'}</strong></td>
        <td><span class="badge ${typeClass}">${typeName}</span></td>
        <td>${d.title||'Sin tÃ­tulo'}</td>
        <td>${d.displayDate||'â€”'}</td>
        <td><span class="badge ${statusClass}">${d.status==='firmado'?'Firmado':d.status==='pendiente'?'Pendiente':'Borrador'}</span></td>
        <td>${evid}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="viewDoc('${d.id}')" title="Ver detalle">ğŸ‘ï¸</button>
          <button class="btn btn-ghost btn-sm" onclick="downloadDocPDF('${d.id}')" title="PDF">ğŸ“•</button>
          <button class="btn btn-ghost btn-sm" onclick="downloadDocWord('${d.id}')" title="Word">ğŸ“„</button>
          <button class="btn btn-ghost btn-sm" onclick="uploadEvidence('${d.id}')" title="Subir evidencia">ğŸ“</button>
        </td>
      </tr>`;
    });
    h+='</tbody></table>';
  }
  h+='</div>';
  document.getElementById('page-content').innerHTML=h;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HISTORIAL (filtered list)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHistorial(type){
  const docs=loadDocs().filter(d=>d.type===type).sort((a,b)=>b.createdAt-a.createdAt);
  const typeNames={minuta:'Minutas',aviso:'Avisos',retroalimentacion:'Retroalimentaciones',plantrabajo:'Planes de Trabajo',actaadmin:'Actas Administrativas',baja:'Bajas'};
  const typeIcons={minuta:'ğŸ“‹',aviso:'ğŸ“¢',retroalimentacion:'ğŸ’¬',plantrabajo:'ğŸ“Š',actaadmin:'âš ï¸',baja:'ğŸšª'};
  const typeName=typeNames[type]||type;

  let h=`<div class="table-wrap">
    <div class="table-toolbar">
      <input class="search-box" placeholder="ğŸ” Buscar por folio, tÃ­tulo..." oninput="filterTable(this.value,'${type}')">
      <select class="filter-sel" onchange="filterByStatus(this.value,'${type}')">
        <option value="">Todos los estatus</option><option value="firmado">Firmados</option><option value="pendiente">Pendientes</option>
      </select>
      <select class="filter-sel" onchange="filterByEvidence(this.value,'${type}')">
        <option value="">Con/Sin evidencia</option><option value="si">Con evidencia</option><option value="no">Sin evidencia</option>
      </select>
      <div style="margin-left:auto"><button class="btn btn-pri btn-sm" onclick="showPage('nuevo')">â• Nuevo</button></div>
    </div>`;

  if(docs.length===0){
    h+=`<div class="empty-state"><div class="icon">${typeIcons[type]||'ğŸ“„'}</div><h3>No hay ${typeName.toLowerCase()}</h3><p>Crea uno nuevo para comenzar.</p></div>`;
  } else {
    h+=`<table class="data-tbl" id="tbl-${type}"><thead><tr><th>Folio</th><th>TÃ­tulo</th><th>Fecha</th><th>Estatus</th><th>Evidencia</th><th>Acciones</th></tr></thead><tbody>`;
    docs.forEach(d=>{
      const sc=d.status==='firmado'?'badge-firmado':d.status==='pendiente'?'badge-pendiente':'badge-borrador';
      const ev=(d.evidence||d.evidenceUrl)?'<span class="evidence-indicator evidence-yes">âœ… SÃ­</span>':'<span class="evidence-indicator evidence-no">â€” No</span>';
      h+=`<tr data-folio="${(d.folio||'').toLowerCase()}" data-title="${(d.title||'').toLowerCase()}" data-status="${d.status}" data-evidence="${(d.evidence||d.evidenceUrl)?'si':'no'}">
        <td><strong>${d.folio||'â€”'}</strong></td><td>${d.title||'â€”'}</td><td>${d.displayDate||'â€”'}</td>
        <td><span class="badge ${sc}">${d.status==='firmado'?'Firmado':d.status==='pendiente'?'Pendiente':'Borrador'}</span></td>
        <td>${ev}</td>
        <td>
          <button class="btn btn-ghost btn-sm" onclick="viewDoc('${d.id}')">ğŸ‘ï¸</button>
          <button class="btn btn-ghost btn-sm" onclick="downloadDocPDF('${d.id}')">ğŸ“•</button>
          <button class="btn btn-ghost btn-sm" onclick="downloadDocWord('${d.id}')">ğŸ“„</button>
          <button class="btn btn-ghost btn-sm" onclick="uploadEvidence('${d.id}')">ğŸ“</button>
          <button class="btn-danger-ghost" onclick="deleteDoc('${d.id}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    });
    h+='</tbody></table>';
  }
  h+='</div>';
  document.getElementById('page-content').innerHTML=h;
}

// Filters
function filterTable(q, type){
  const rows=document.querySelectorAll(`#tbl-${type} tbody tr`);
  q=q.toLowerCase();
  rows.forEach(r=>{r.style.display=(r.dataset.folio.includes(q)||r.dataset.title.includes(q))?'':'none';});
}
function filterByStatus(val, type){
  const rows=document.querySelectorAll(`#tbl-${type} tbody tr`);
  rows.forEach(r=>{r.style.display=(!val||r.dataset.status===val)?'':'none';});
}
function filterByEvidence(val, type){
  const rows=document.querySelectorAll(`#tbl-${type} tbody tr`);
  rows.forEach(r=>{r.style.display=(!val||r.dataset.evidence===val)?'':'none';});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW DOC DETAIL (Modal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function viewDoc(id){
  const docs=loadDocs(); const d=docs.find(x=>x.id===id); if(!d)return;
  const isM=d.type==='minuta';
  let h=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal">
    <div class="modal-hdr"><h2>${isM?'ğŸ“‹ Minuta':'ğŸ“¢ Aviso'}: ${d.folio||d.id}</h2><button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button></div>
    <div class="modal-body">
      <div class="detail-grid">
        <div class="detail-section"><h3>InformaciÃ³n General</h3>
          <div class="detail-row"><span class="dl">Folio</span><span class="dv">${d.folio||'â€”'}</span></div>
          <div class="detail-row"><span class="dl">Tipo</span><span class="dv">${isM?'Minuta de ReuniÃ³n':'Aviso Interno'}</span></div>
          <div class="detail-row"><span class="dl">Fecha</span><span class="dv">${d.displayDate||'â€”'}</span></div>
          <div class="detail-row"><span class="dl">Estatus</span><span class="dv"><span class="badge ${d.status==='firmado'?'badge-firmado':'badge-pendiente'}">${d.status==='firmado'?'Firmado':'Pendiente'}</span></span></div>
          <div class="detail-row"><span class="dl">Creado</span><span class="dv">${new Date(d.createdAt).toLocaleString('es-MX')}</span></div>
        </div>
        <div class="detail-section"><h3>Detalle</h3>
          ${isM?`
            <div class="detail-row"><span class="dl">Tipo reuniÃ³n</span><span class="dv">${d.data?.tipo||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">UbicaciÃ³n</span><span class="dv">${d.data?.ubicacion||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">Convocada por</span><span class="dv">${d.data?.convoca||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">Objetivo</span><span class="dv">${d.data?.objetivo||'â€”'}</span></div>
          `:`
            <div class="detail-row"><span class="dl">Tipo aviso</span><span class="dv">${d.data?.tipo||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">Emitido por</span><span class="dv">${d.data?.emitido||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">Dirigido a</span><span class="dv">${d.data?.dirigido||'â€”'}</span></div>
            <div class="detail-row"><span class="dl">Asunto</span><span class="dv">${d.data?.asunto||'â€”'}</span></div>
          `}
        </div>
      </div>`;

  // Evidence section
  h+='<div class="detail-section" style="margin-top:14px;grid-column:1/-1"><h3>ğŸ“ Evidencia Firmada</h3>';
  if(d.evidence){
    h+=`<p style="font-size:12px;color:var(--ok);margin-bottom:6px">âœ… Documento firmado cargado el ${new Date(d.evidenceDate).toLocaleString('es-MX')}</p>`;
    if(d.evidence.startsWith('data:image')){
      h+=`<img src="${d.evidence}" class="evidence-img">`;
    } else {
      h+=`<p style="font-size:12px;color:var(--muted)">ğŸ“„ Archivo PDF cargado</p>`;
    }
    h+=`<div style="margin-top:8px"><button class="btn btn-ghost btn-sm" onclick="uploadEvidence('${d.id}');this.closest('.modal-overlay').remove()">ğŸ”„ Reemplazar</button></div>`;
  } else {
    h+=`<p style="font-size:12px;color:var(--muted);margin-bottom:8px">No se ha cargado evidencia firmada aÃºn.</p>`;
    h+=`<button class="btn btn-pri btn-sm" onclick="uploadEvidence('${d.id}');this.closest('.modal-overlay').remove()">ğŸ“ Subir evidencia firmada</button>`;
  }
  h+='</div>';

  // Status change
  h+=`<div style="margin-top:14px;display:flex;gap:8px">
    <button class="btn ${d.status==='firmado'?'btn-ghost':'btn-ok'} btn-sm" onclick="changeStatus('${d.id}','firmado')">âœ… Marcar como firmado</button>
    <button class="btn ${d.status==='pendiente'?'btn-ghost':'btn-warn'} btn-sm" onclick="changeStatus('${d.id}','pendiente')">â³ Marcar como pendiente</button>
  </div>`;

  h+=`</div><div class="modal-footer">
    <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Cerrar</button>
    <button class="btn btn-pri" onclick="downloadDocPDF('${d.id}')">ğŸ“• PDF</button>
    <button class="btn btn-pri" onclick="downloadDocWord('${d.id}')">ğŸ“„ Word</button>
  </div></div></div>`;
  document.body.insertAdjacentHTML('beforeend',h);
}

function changeStatus(id, status){
  const docs=loadDocs(); const d=docs.find(x=>x.id===id);
  if(d){d.status=status;saveDocs(docs);toast(status==='firmado'?'âœ… Documento marcado como firmado':'â³ Documento marcado como pendiente');document.querySelector('.modal-overlay')?.remove();showPage(currentPage);}
}

function deleteDoc(id){
  if(!confirm('Â¿Eliminar este documento permanentemente?'))return;
  const docs=loadDocs().filter(x=>x.id!==id);saveDocs(docs);toast('ğŸ—‘ï¸ Documento eliminado','info');showPage(currentPage);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPLOAD EVIDENCE (Modal)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function uploadEvidence(id){
  let h=`<div class="modal-overlay" onclick="if(event.target===this)this.remove()"><div class="modal" style="max-width:500px">
    <div class="modal-hdr"><h2>ğŸ“ Subir Evidencia Firmada</h2><button class="modal-close" onclick="this.closest('.modal-overlay').remove()">âœ•</button></div>
    <div class="modal-body">
      <p style="font-size:13px;color:var(--muted);margin-bottom:14px">Sube una foto o escaneo del documento firmado como evidencia.</p>
      <div class="upload-zone" id="drop-zone" onclick="document.getElementById('file-input').click()"
        ondragover="event.preventDefault();this.classList.add('dragover')"
        ondragleave="this.classList.remove('dragover')"
        ondrop="event.preventDefault();this.classList.remove('dragover');handleFileDrop(event,'${id}')">
        <div class="upload-icon">ğŸ“¤</div>
        <div class="upload-text"><b>Clic para seleccionar</b> o arrastra aquÃ­</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">JPG, PNG o PDF â€¢ MÃ¡x 5MB</div>
      </div>
      <input type="file" id="file-input" accept="image/*,.pdf" style="display:none" onchange="handleFileSelect(this,'${id}')">
      <div id="file-preview-area"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="this.closest('.modal-overlay').remove()">Cancelar</button>
      <button class="btn btn-ok" id="btn-save-evidence" onclick="saveEvidence('${id}')" disabled>ğŸ’¾ Guardar evidencia</button>
    </div>
  </div></div>`;
  document.body.insertAdjacentHTML('beforeend',h);
}

let pendingEvidence = null;

function handleFileSelect(input, id){
  const file=input.files[0]; if(!file)return; processFile(file, id);
}
function handleFileDrop(event, id){
  const file=event.dataTransfer.files[0]; if(!file)return; processFile(file, id);
}
function processFile(file, id){
  if(file.size>5*1024*1024){toast('El archivo es muy grande (mÃ¡x 5MB)','err');return;}
  const reader=new FileReader();
  reader.onload=function(e){
    pendingEvidence = e.target.result;
    let preview='';
    if(file.type.startsWith('image/')){
      preview=`<div class="file-preview"><img src="${e.target.result}"><div class="info"><div class="name">${file.name}</div><div class="size">${(file.size/1024).toFixed(1)} KB</div></div></div>`;
    } else {
      preview=`<div class="file-preview"><div style="font-size:28px">ğŸ“„</div><div class="info"><div class="name">${file.name}</div><div class="size">${(file.size/1024).toFixed(1)} KB</div></div></div>`;
    }
    document.getElementById('file-preview-area').innerHTML=preview;
    document.getElementById('btn-save-evidence').disabled=false;
  };
  reader.readAsDataURL(file);
}

function saveEvidence(id){
  if(!pendingEvidence)return;
  const docs=loadDocs(); const d=docs.find(x=>x.id===id);
  if(d){
    d.evidence=pendingEvidence;
    d.evidenceDate=Date.now();
    d.status='firmado';
    saveDocs(docs);
    // Upload evidence to Drive folder
    uploadEvidenceToDrive(id, pendingEvidence, d.folio);
    toast('âœ… Evidencia guardada y documento marcado como firmado');
    pendingEvidence=null;
    document.querySelector('.modal-overlay')?.remove();
    showPage(currentPage);
  }
}

function uploadEvidenceToDrive(docId, base64, folio){
  const cfg=loadDriveConfig();
  if(!cfg.url||!cfg.connected)return;
  fetch(cfg.url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'uploadEvidence',id:docId,evidence:base64,fileName:folio+'_evidencia'})}).catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ANEXOS (IMAGES)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let anexosData = [];

function handleAnexos(input){
  const files = input.files;
  if(!files.length) return;
  
  Array.from(files).forEach(file => {
    if(file.size > 5*1024*1024){
      toast('Imagen muy grande (mÃ¡x 5MB)', 'err');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e){
      anexosData.push({name: file.name, data: e.target.result});
      renderAnexosPreview();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderAnexosPreview(){
  const container = document.getElementById('anexos-preview');
  if(!container) return;
  let h = '';
  anexosData.forEach((img, i) => {
    h += `<div class="file-preview" style="margin-bottom:8px">
      <img src="${img.data}" style="width:80px;height:80px;object-fit:cover;border-radius:6px">
      <div class="info"><div class="name">${img.name}</div></div>
      <button type="button" onclick="removeAnexo(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:18px">âœ•</button>
    </div>`;
  });
  container.innerHTML = h;
}

function removeAnexo(i){
  anexosData.splice(i, 1);
  renderAnexosPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVALUACIÃ“N DE LLAMADAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleEvalLlamada(){
  const tipo = document.getElementById('f-rtipo')?.value;
  const evalSection = document.getElementById('eval-llamada-section');
  const normalSection = document.getElementById('retro-normal-section');
  if(evalSection && normalSection){
    if(tipo === 'EvaluaciÃ³n de llamada'){
      evalSection.style.display = 'block';
      normalSection.style.display = 'none';
    } else {
      evalSection.style.display = 'none';
      normalSection.style.display = 'block';
    }
  }
}

function calcularEval(){
  const campos = ['saludo','tono','sondeo','objeciones','cierre','valorizacion','monetizacion','producto','fluidez'];
  let total = 0;
  campos.forEach(c => {
    const el = document.getElementById('f-eval-'+c);
    if(el) total += parseInt(el.value)||0;
  });
  const totalEl = document.getElementById('eval-total');
  const totalBigEl = document.getElementById('eval-total-big');
  if(totalEl) totalEl.textContent = total;
  if(totalBigEl){
    totalBigEl.textContent = total + '%';
    totalBigEl.style.color = total >= 80 ? 'var(--ok)' : total >= 60 ? 'var(--warn)' : 'var(--red)';
  }
  return total;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CÃLCULO FINIQUITO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcularFiniquito(){
  const sueldo = parseFloat(document.getElementById('f-bsueldo')?.value)||0;
  const dias = parseFloat(document.getElementById('f-bdias')?.value)||0;
  const vacaciones = parseFloat(document.getElementById('f-bvacaciones')?.value)||0;
  const aguinaldo = parseFloat(document.getElementById('f-baguinaldo')?.value)||0;
  const primaPct = parseFloat(document.getElementById('f-bprima')?.value)||25;
  const comisiones = parseFloat(document.getElementById('f-bcomisiones')?.value)||0;
  const otros = parseFloat(document.getElementById('f-botros')?.value)||0;
  
  const montoDias = dias * sueldo;
  const montoVac = vacaciones * sueldo;
  const montoAgui = aguinaldo * sueldo;
  const montoPrima = montoVac * (primaPct/100);
  const total = montoDias + montoVac + montoAgui + montoPrima + comisiones + otros;
  
  document.getElementById('f-bdiasmon').value = '$' + montoDias.toFixed(2);
  document.getElementById('f-bvacmon').value = '$' + montoVac.toFixed(2);
  document.getElementById('f-baguimon').value = '$' + montoAgui.toFixed(2);
  document.getElementById('f-bprimamon').value = '$' + montoPrima.toFixed(2);
  document.getElementById('f-btotal').textContent = '$' + total.toFixed(2);
  
  return {montoDias, montoVac, montoAgui, montoPrima, comisiones, otros, total};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DOCUMENTOS BAJA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let docsBajaData = [];

function handleDocsBaja(input){
  const files = input.files;
  if(!files.length) return;
  
  Array.from(files).forEach(file => {
    if(file.size > 5*1024*1024){
      toast('Archivo muy grande (mÃ¡x 5MB)', 'err');
      return;
    }
    const reader = new FileReader();
    reader.onload = function(e){
      docsBajaData.push({name: file.name, data: e.target.result, type: file.type});
      renderDocsBajaPreview();
    };
    reader.readAsDataURL(file);
  });
  input.value = '';
}

function renderDocsBajaPreview(){
  const container = document.getElementById('docs-baja-preview');
  if(!container) return;
  let h = '';
  docsBajaData.forEach((doc, i) => {
    const icon = doc.type.includes('pdf') ? 'ğŸ“„' : 'ğŸ–¼ï¸';
    h += `<div class="file-preview" style="margin-bottom:8px">
      <span style="font-size:24px">${icon}</span>
      <div class="info"><div class="name">${doc.name}</div></div>
      <button type="button" onclick="removeDocBaja(${i})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:18px">âœ•</button>
    </div>`;
  });
  container.innerHTML = h;
}

function removeDocBaja(i){
  docsBajaData.splice(i, 1);
  renderDocsBajaPreview();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE DRIVE INTEGRATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDrive(){
  const cfg=loadDriveConfig();
  let h=`<div class="config-box">
    <h3>â˜ï¸ ConexiÃ³n con Google Drive</h3>
    <p>Conecta tu Google Apps Script para que los documentos y evidencias se respalden automÃ¡ticamente en tu Drive. Usa el mismo patrÃ³n del sistema de reclutamiento.</p>
    <div class="config-status ${cfg.connected?'connected':'disconnected'}">${cfg.connected?'âœ… Conectado':'âšª No conectado'}</div>
  </div>

  <div class="config-box">
    <h3>ğŸ”— URL del Web App (Apps Script)</h3>
    <p>Pega aquÃ­ la URL de tu Google Apps Script desplegado como Web App. El script debe aceptar POST con los datos del documento y la evidencia en base64.</p>
    <div class="fg"><input id="drive-url" value="${cfg.url||''}" placeholder="https://script.google.com/macros/s/AKfycb.../exec" style="font-size:13px"></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-pri btn-sm" onclick="saveDriveURL()">ğŸ’¾ Guardar URL</button>
      <button class="btn btn-ghost btn-sm" onclick="testDriveConnection()">ğŸ§ª Probar conexiÃ³n</button>
    </div>
  </div>

  <div class="config-box">
    <h3>ğŸ“‹ CÃ³digo Apps Script</h3>
    <p>Copia este cÃ³digo en tu proyecto de Google Apps Script. Crea una hoja llamada <b>"Documentos"</b> y una carpeta en Drive para las evidencias.</p>
    <div style="background:#1a1a2e;border-radius:8px;padding:16px;margin-top:8px;overflow-x:auto">
      <pre style="color:#e0e0e0;font-size:11px;font-family:'Fira Code',monospace;line-height:1.6;margin:0;white-space:pre-wrap"><code style="color:#a8d8ea">// â•â•â• ExpertCell - GestiÃ³n Documental â•â•â•
// Configurar estas variables:
const SHEET_NAME = 'Documentos';
const FOLDER_ID = 'TU_FOLDER_ID_AQUI'; // ID de la carpeta en Drive

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    let sheet = ss.getSheetByName(SHEET_NAME);
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      sheet.appendRow(['ID','Tipo','Folio','TÃ­tulo','Fecha',
        'Estatus','Creado','URL Evidencia','Datos JSON']);
      sheet.getRange(1,1,1,9).setFontWeight('bold')
        .setBackground('#0D4F80').setFontColor('#fff');
    }

    let evidenceUrl = '';
    // Si viene evidencia en base64, guardarla en Drive
    if (data.evidence && data.evidence.startsWith('data:')) {
      const parts = data.evidence.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const bytes = Utilities.base64Decode(parts[1]);
      const blob = Utilities.newBlob(bytes, mime,
        data.folio + '_evidencia.' + (mime.includes('pdf')?'pdf':'jpg'));
      const folder = DriveApp.getFolderById(FOLDER_ID);
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK,
        DriveApp.Permission.VIEW);
      evidenceUrl = file.getUrl();
    }

    // Buscar si ya existe el registro para actualizar
    const dataRange = sheet.getDataRange().getValues();
    let rowIndex = -1;
    for (let i = 1; i &lt; dataRange.length; i++) {
      if (dataRange[i][0] === data.id) { rowIndex = i + 1; break; }
    }

    const rowData = [data.id, data.type, data.folio||'',
      data.title||'', data.displayDate||'', data.status||'',
      new Date().toLocaleString('es-MX'),
      evidenceUrl, JSON.stringify(data.data||{})];

    if (rowIndex > 0) {
      sheet.getRange(rowIndex, 1, 1, 9).setValues([rowData]);
    } else {
      sheet.appendRow(rowData);
    }

    return ContentService.createTextOutput(
      JSON.stringify({success:true, evidenceUrl}))
      .setMimeType(ContentService.MimeType.JSON);
  } catch(err) {
    return ContentService.createTextOutput(
      JSON.stringify({success:false, error:err.toString()}))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  return ContentService.createTextOutput(
    JSON.stringify({status:'ok', message:'ExpertCell Docs API activa'}))
    .setMimeType(ContentService.MimeType.JSON);
}</code></pre>
    </div>
    <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="copyAppsScript()">ğŸ“‹ Copiar cÃ³digo</button>
  </div>

  <div class="config-box">
    <h3>ğŸ“– Instrucciones</h3>
    <ol style="font-size:12px;color:var(--txt);line-height:1.8;padding-left:20px">
      <li>Abre <b>script.google.com</b> y crea un nuevo proyecto</li>
      <li>Pega el cÃ³digo de arriba en Code.gs</li>
      <li>Crea una carpeta en Drive para las evidencias y copia su ID de la URL</li>
      <li>Reemplaza <b>TU_FOLDER_ID_AQUI</b> con el ID de tu carpeta</li>
      <li>Implementar â†’ Nueva implementaciÃ³n â†’ App web â†’ Ejecutar como: Yo â†’ Acceso: Cualquier persona</li>
      <li>Copia la URL generada y pÃ©gala arriba</li>
      <li>Dale clic en "Probar conexiÃ³n" para verificar</li>
    </ol>
  </div>`;

  document.getElementById('page-content').innerHTML=h;
}

function saveDriveURL(){
  const url=document.getElementById('drive-url').value.trim();
  saveDriveConfig({url,connected:!!url});
  toast(url?'âœ… URL de Drive guardada':'âš ï¸ URL removida','info');
  renderDrive();
}
function testDriveConnection(){
  const cfg=loadDriveConfig();
  if(!cfg.url){toast('Primero guarda una URL','err');return;}
  toast('ğŸ”„ Probando conexiÃ³n...','info');
  fetch(cfg.url).then(r=>r.json()).then(d=>{
    if(d.status==='ok'){saveDriveConfig({...cfg,connected:true});toast('âœ… ConexiÃ³n exitosa con Drive');renderDrive();}
    else toast('âŒ Error en la respuesta','err');
  }).catch(e=>{toast('âŒ No se pudo conectar: '+e.message,'err');});
}
function copyAppsScript(){
  const code=document.querySelector('.config-box pre code').textContent;
  navigator.clipboard?.writeText(code).then(()=>toast('ğŸ“‹ CÃ³digo copiado al portapapeles','info')).catch(()=>toast('No se pudo copiar','err'));
}

function uploadToDrive(docData){
  const cfg=loadDriveConfig();
  if(!cfg.url||!cfg.connected)return;
  fetch(cfg.url,{method:'POST',headers:{'Content-Type':'text/plain'},body:JSON.stringify({action:'save',document:docData})}).catch(()=>{});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NEW DOCUMENT FORM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let newDocType = 'minuta';
let formAsistentes=[{nombre:'',cargo:'',asistencia:'Presente'},{nombre:'',cargo:'',asistencia:'Presente'},{nombre:'',cargo:'',asistencia:'Presente'}];
let formOrden=[{horario:'',tema:'',responsable:''},{horario:'',tema:'',responsable:''}];
let formDesarrollo=[{tema:'',descripcion:'',decision:''}];
let formAcuerdos=[{compromiso:'',responsable:'',fecha:'',prioridad:'Alta',estatus:'Pendiente'}];
let formFirmasM=[{nombre:'',cargo:''},{nombre:'',cargo:''},{nombre:'',cargo:''}];
let formAcciones=[{accion:'',responsable:'',fecha:''}];
let formFirmasA=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
let formFirmasR=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
let formFirmasP=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
let formFirmasB=[{nombre:'',cargo:''},{nombre:'',cargo:''}];

function resetFormArrays(){
  formAsistentes=[{nombre:'',cargo:'',asistencia:'Presente'},{nombre:'',cargo:'',asistencia:'Presente'},{nombre:'',cargo:'',asistencia:'Presente'}];
  formOrden=[{horario:'',tema:'',responsable:''},{horario:'',tema:'',responsable:''}];
  formDesarrollo=[{tema:'',descripcion:'',decision:''}];
  formAcuerdos=[{compromiso:'',responsable:'',fecha:'',prioridad:'Alta',estatus:'Pendiente'}];
  formFirmasM=[{nombre:'',cargo:''},{nombre:'',cargo:''},{nombre:'',cargo:''}];
  formAcciones=[{accion:'',responsable:'',fecha:''}];
  formFirmasA=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
  formFirmasR=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
  formFirmasP=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
  formFirmasB=[{nombre:'',cargo:''},{nombre:'',cargo:''}];
}

function renderNuevo(){
  resetFormArrays();
  anexosData = [];
  docsBajaData = [];
  let h=`
  <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
    <button class="btn ${newDocType==='minuta'?'btn-pri':'btn-ghost'}" onclick="newDocType='minuta';renderNuevo()">ğŸ“‹ Minuta</button>
    <button class="btn ${newDocType==='aviso'?'btn-pri':'btn-ghost'}" onclick="newDocType='aviso';renderNuevo()">ğŸ“¢ Aviso</button>
    <button class="btn ${newDocType==='retroalimentacion'?'btn-pri':'btn-ghost'}" onclick="newDocType='retroalimentacion';renderNuevo()">ğŸ’¬ RetroalimentaciÃ³n</button>
    <button class="btn ${newDocType==='plantrabajo'?'btn-pri':'btn-ghost'}" onclick="newDocType='plantrabajo';renderNuevo()">ğŸ“Š Plan de Trabajo</button>
    <button class="btn ${newDocType==='actaadmin'?'btn-pri':'btn-ghost'}" onclick="newDocType='actaadmin';renderNuevo()">âš ï¸ Acta Administrativa</button>
    <button class="btn ${newDocType==='baja'?'btn-pri':'btn-ghost'}" onclick="newDocType='baja';renderNuevo()">ğŸšª Baja</button>
  </div>
  <div style="display:flex;gap:22px">
    <div style="flex:1;min-width:0" id="form-area"></div>
  </div>`;
  document.getElementById('page-content').innerHTML=h;
  renderFormContent();
}

function renderFormContent(){
  const fa=document.getElementById('form-area');
  if(!fa)return;
  let h='';
  if(newDocType==='minuta'){
    h+=`<div class="sec-title">ğŸ“… InformaciÃ³n de la ReuniÃ³n</div>
    <div class="grid2">
      <div class="fg"><label>Tipo</label><select id="f-tipo"><option>Dinamicas</option><option>OperaciÃ³n</option><option>Administrativo</option><option>Comunicados generales</option><option>Pagos</option></select></div>
      <div class="fg"><label>Folio</label><input id="f-folio" value="EC-MIN-${String(loadDocs().filter(d=>d.type==='minuta').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-fecha"></div>
      <div class="fg"><label>UbicaciÃ³n</label><select id="f-ubicacion"><option>Celula Neza</option><option>Celula Atlixco</option><option>Sub Yelitza Orsuna</option></select></div>
      <div class="fg"><label>Hora inicio</label><input type="time" id="f-hinicio"></div>
      <div class="fg"><label>Hora tÃ©rmino</label><input type="time" id="f-hfin"></div>
      <div class="fg"><label>Convocada por <span class="req">*</span></label><input id="f-convoca" placeholder="Nombre â€“ Cargo"></div>
      <div class="fg"><label>Elabora minuta</label><input id="f-elabora" placeholder="Nombre"></div>
    </div>
    <div class="fg"><label>Objetivo</label><textarea id="f-objetivo" rows="2" placeholder="PropÃ³sito de la reuniÃ³n..."></textarea></div>
    <div class="fg"><label>DescripciÃ³n</label><textarea id="f-descripcion" rows="4" placeholder="Redacta el tema de la minuta..."></textarea></div>`;

    h+=`<div class="sec-title">ğŸ‘¥ Lista de Asistencia</div><div id="tbl-asist"></div>`;
    h+=`<div class="sec-title">ğŸ’¬ Desarrollo</div><div id="tbl-desarrollo"></div>`;
    h+=`<div class="sec-title">âœ… Acuerdos y Compromisos</div><div id="tbl-acuerdos"></div>`;

    h+=`<div class="sec-title">ğŸ“† PrÃ³xima ReuniÃ³n</div>
    <div class="grid2">
      <div class="fg"><label>Fecha</label><input type="date" id="f-proxfecha"></div>
      <div class="fg"><label>Hora</label><input type="time" id="f-proxhora"></div>
    </div>
    <div class="fg"><label>Lugar</label><input id="f-proxlugar"></div>
    <div class="fg"><label>Temas pendientes</label><textarea id="f-proxtemas" rows="2"></textarea></div>`;

    h+=`<div class="sec-title">ğŸ“Œ Observaciones</div>
    <div class="fg"><textarea id="f-obs" rows="3" placeholder="Notas adicionales..."></textarea></div>`;

    h+=`<div class="sec-title">ğŸ“ Anexos (ImÃ¡genes/Tablas)</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b> o arrastra aquÃ­</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px">JPG, PNG â€¢ Puedes agregar varias</div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;

    h+=`<div class="sec-title">âœï¸ Firmas</div><div id="tbl-firmasM"></div>`;
  } else if(newDocType==='aviso'){
    h+=`<div class="sec-title">ğŸ“‹ Datos del Comunicado</div>
    <div class="grid2">
      <div class="fg"><label>Tipo</label><select id="f-atipo"><option>Informativo</option><option>Cambio operativo</option><option>PolÃ­tica</option><option>Urgente</option><option>Oferta comercial</option><option>Dinamicas</option><option>Otros</option></select></div>
      <div class="fg"><label>Folio</label><input id="f-afolio" value="EC-AVI-${String(loadDocs().filter(d=>d.type==='aviso').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-afecha"></div>
      <div class="fg"><label>Vigencia</label><input id="f-avigencia" placeholder="Permanente / Fechas"></div>
      <div class="fg"><label>Emitido por <span class="req">*</span></label><input id="f-aemitido" placeholder="Nombre â€“ Cargo"></div>
      <div class="fg"><label>Dirigido a</label><select id="f-adirigido"><option>Todo el personal</option><option>Celula Atlixco</option><option>Celula Neza</option><option>Administrativos</option><option>Operacion de ventas</option><option>Mineria</option><option>Control documental</option><option>Coordinacion</option><option>Supervision</option><option>Agentes de ventas</option></select></div>
    </div>
    <div class="fg"><label>Prioridad</label><select id="f-aprioridad"><option>Normal</option><option>Importante</option><option>Urgente</option></select></div>`;

    h+=`<div class="sec-title">ğŸ“„ Asunto y Contenido</div>
    <div class="fg"><label>Asunto <span class="req">*</span></label><input id="f-aasunto" placeholder="TÃ­tulo del aviso"></div>
    <div class="fg"><label>Contenido</label><textarea id="f-acontenido" rows="5" placeholder="Contexto, descripciÃ³n, impacto, acciones..."></textarea></div>`;

    h+=`<div class="sec-title">âš¡ Acciones Requeridas</div><div id="tbl-acciones"></div>`;
    h+=`<div class="sec-title">ğŸ“ Contacto</div>
    <div class="fg"><label>Contacto para dudas</label><input id="f-acontacto" placeholder="Nombre â€“ Tel / Email"></div>`;
    h+=`<div class="sec-title">ğŸ“ Anexos (ImÃ¡genes/Tablas)</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b></div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;
    h+=`<div class="sec-title">âœï¸ Firmas</div><div id="tbl-firmasA"></div>`;
  } else if(newDocType==='retroalimentacion'){
    h+=`<div class="sec-title">ğŸ’¬ RetroalimentaciÃ³n</div>
    <div class="grid2">
      <div class="fg"><label>Folio</label><input id="f-rfolio" value="EC-RET-${String(loadDocs().filter(d=>d.type==='retroalimentacion').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-rfecha"></div>
      <div class="fg"><label>Colaborador <span class="req">*</span></label><input id="f-rcolaborador" placeholder="Nombre del colaborador"></div>
      <div class="fg"><label>Puesto</label><input id="f-rpuesto" placeholder="Puesto"></div>
      <div class="fg"><label>Ãrea</label><select id="f-rarea"><option>Celula Atlixco</option><option>Celula Neza</option><option>Administrativos</option><option>Operacion de ventas</option><option>Mineria</option><option>Control documental</option><option>Coordinacion</option><option>Supervision</option></select></div>
      <div class="fg"><label>Supervisor</label><input id="f-rsupervisor" placeholder="Nombre del supervisor"></div>
    </div>
    <div class="fg"><label>Tipo de RetroalimentaciÃ³n</label><select id="f-rtipo" onchange="toggleEvalLlamada()"><option>Positiva</option><option>Correctiva</option><option>Desarrollo</option><option>EvaluaciÃ³n de llamada</option></select></div>
    
    <div id="eval-llamada-section" style="display:none">
      <div class="sec-title">ğŸ“ Datos de la Llamada</div>
      <div class="grid2">
        <div class="fg"><label>Tiempo de llamada</label><input id="f-rtiempollamada" placeholder="Ej: 5:32 min"></div>
        <div class="fg"><label>NÃºmero marcado</label><input id="f-rnumero" placeholder="TelÃ©fono"></div>
        <div class="fg"><label>TipificaciÃ³n</label><input id="f-rtipificacion" placeholder="Resultado de la llamada"></div>
      </div>
      
      <div class="sec-title">ğŸ“Š EvaluaciÃ³n de Calidad (Total: <span id="eval-total">0</span>%)</div>
      <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin-bottom:12px">
        <div class="grid2">
          <div class="fg"><label>Saludo (10%)</label><select id="f-eval-saludo" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="5">5 - Parcial</option><option value="10">10 - Cumple</option></select></div>
          <div class="fg"><label>Tono de voz (10%)</label><select id="f-eval-tono" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="5">5 - Parcial</option><option value="10">10 - Cumple</option></select></div>
          <div class="fg"><label>Sondeo de necesidades (15%)</label><select id="f-eval-sondeo" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="7">7 - Parcial</option><option value="15">15 - Cumple</option></select></div>
          <div class="fg"><label>Manejo de objeciones (15%)</label><select id="f-eval-objeciones" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="7">7 - Parcial</option><option value="15">15 - Cumple</option></select></div>
          <div class="fg"><label>Cierre de venta (15%)</label><select id="f-eval-cierre" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="7">7 - Parcial</option><option value="15">15 - Cumple</option></select></div>
          <div class="fg"><label>ValorizaciÃ³n (10%)</label><select id="f-eval-valorizacion" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="5">5 - Parcial</option><option value="10">10 - Cumple</option></select></div>
          <div class="fg"><label>MonetizaciÃ³n (10%)</label><select id="f-eval-monetizacion" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="5">5 - Parcial</option><option value="10">10 - Cumple</option></select></div>
          <div class="fg"><label>Manejo de producto (10%)</label><select id="f-eval-producto" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="5">5 - Parcial</option><option value="10">10 - Cumple</option></select></div>
          <div class="fg"><label>Fluidez en la llamada (5%)</label><select id="f-eval-fluidez" onchange="calcularEval()"><option value="0">0 - No cumple</option><option value="2">2 - Parcial</option><option value="5">5 - Cumple</option></select></div>
        </div>
        <div style="text-align:center;margin-top:12px;padding:10px;background:var(--lt);border-radius:8px">
          <span style="font-size:24px;font-weight:700;color:var(--dk)" id="eval-total-big">0%</span>
          <div style="font-size:11px;color:var(--muted)">CalificaciÃ³n Total</div>
        </div>
      </div>
    </div>
    
    <div id="retro-normal-section">
      <div class="fg"><label>Motivo / SituaciÃ³n</label><textarea id="f-rmotivo" rows="3" placeholder="Describe la situaciÃ³n..."></textarea></div>
      <div class="fg"><label>RetroalimentaciÃ³n</label><textarea id="f-rcontenido" rows="4" placeholder="Detalle de la retroalimentaciÃ³n..."></textarea></div>
      <div class="fg"><label>Compromisos</label><textarea id="f-rcompromisos" rows="3" placeholder="Compromisos acordados..."></textarea></div>
      <div class="fg"><label>Seguimiento</label><input id="f-rseguimiento" placeholder="Fecha o acciones de seguimiento"></div>
    </div>`;
    h+=`<div class="sec-title">ğŸ“ Anexos</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b></div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;
    h+=`<div class="sec-title">âœï¸ Firmas</div><div id="tbl-firmasR"></div>`;
  } else if(newDocType==='plantrabajo'){
    h+=`<div class="sec-title">ğŸ“Š Plan de Trabajo</div>
    <div class="grid2">
      <div class="fg"><label>Folio</label><input id="f-pfolio" value="EC-PLN-${String(loadDocs().filter(d=>d.type==='plantrabajo').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-pfecha"></div>
      <div class="fg"><label>Colaborador <span class="req">*</span></label><input id="f-pcolaborador" placeholder="Nombre del colaborador"></div>
      <div class="fg"><label>Puesto</label><input id="f-ppuesto" placeholder="Puesto"></div>
      <div class="fg"><label>Ãrea</label><select id="f-parea"><option>Celula Atlixco</option><option>Celula Neza</option><option>Administrativos</option><option>Operacion de ventas</option><option>Mineria</option><option>Control documental</option><option>Coordinacion</option><option>Supervision</option></select></div>
      <div class="fg"><label>Supervisor</label><input id="f-psupervisor" placeholder="Nombre del supervisor"></div>
    </div>
    <div class="fg"><label>Periodo</label><input id="f-pperiodo" placeholder="Ej: Febrero 2026"></div>
    <div class="fg"><label>Objetivo del Plan</label><textarea id="f-pobjetivo" rows="3" placeholder="Objetivo principal..."></textarea></div>
    <div class="fg"><label>Actividades / Metas</label><textarea id="f-pactividades" rows="4" placeholder="Lista de actividades y metas..."></textarea></div>
    <div class="fg"><label>Indicadores de Ã‰xito</label><textarea id="f-pindicadores" rows="3" placeholder="CÃ³mo se medirÃ¡ el Ã©xito..."></textarea></div>
    <div class="fg"><label>Fecha de RevisiÃ³n</label><input type="date" id="f-prevision"></div>`;
    h+=`<div class="sec-title">ğŸ“ Anexos</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b></div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;
    h+=`<div class="sec-title">âœï¸ Firmas</div><div id="tbl-firmasP"></div>`;
  } else if(newDocType==='actaadmin'){
    h+=`<div class="sec-title">âš ï¸ Acta Administrativa</div>
    <div class="grid2">
      <div class="fg"><label>Folio</label><input id="f-aafolio" value="EC-ACT-${String(loadDocs().filter(d=>d.type==='actaadmin').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-aafecha"></div>
      <div class="fg"><label>Colaborador <span class="req">*</span></label><input id="f-aacolaborador" placeholder="Nombre del colaborador"></div>
      <div class="fg"><label>Puesto</label><input id="f-aapuesto" placeholder="Puesto"></div>
      <div class="fg"><label>Ãrea</label><select id="f-aaarea"><option>Celula Atlixco</option><option>Celula Neza</option><option>Administrativos</option><option>Operacion de ventas</option><option>Mineria</option><option>Control documental</option><option>Coordinacion</option><option>Supervision</option></select></div>
      <div class="fg"><label>AntigÃ¼edad</label><input id="f-aaantiguedad" placeholder="Tiempo en la empresa"></div>
    </div>
    <div class="grid2">
      <div class="fg"><label>Tipo de Falta</label><select id="f-aatipo"><option>Falta leve</option><option>Falta grave</option><option>Falta muy grave</option></select></div>
      <div class="fg"><label>NÃºmero de Incidencia</label><select id="f-aanumero"><option>Primera</option><option>Segunda</option><option>Tercera</option></select></div>
    </div>
    <div class="fg"><label>DescripciÃ³n de los Hechos <span class="req">*</span></label><textarea id="f-aahechos" rows="5" placeholder="DescripciÃ³n detallada de los hechos que motivaron el acta..."></textarea></div>
    <div class="fg"><label>Fundamento / Normativa</label><textarea id="f-aafundamento" rows="2" placeholder="ArtÃ­culos o polÃ­ticas que se incumplen..."></textarea></div>
    <div class="fg"><label>SanciÃ³n Aplicada <span class="req">*</span></label><textarea id="f-aasancion" rows="3" placeholder="SanciÃ³n que se aplica al colaborador..."></textarea></div>
    <div class="fg"><label>Compromiso del Colaborador</label><textarea id="f-aacompromiso" rows="3" placeholder="Compromiso del colaborador para evitar reincidencia..."></textarea></div>
    
    <div class="sec-title">ğŸ“‹ Acuerdos y Revisiones</div>
    <div class="fg"><label>Acuerdos para continuidad</label><textarea id="f-aaacuerdos" rows="3" placeholder="Acuerdos establecidos para evaluar la continuidad del empleado..."></textarea></div>
    <div class="grid2">
      <div class="fg"><label>Fecha de revisiÃ³n</label><input type="date" id="f-aarevision"></div>
      <div class="fg"><label>Responsable de seguimiento</label><input id="f-aaresponsable" placeholder="Nombre del responsable"></div>
    </div>
    
    <div class="sec-title">âœï¸ Firmas</div>
    <div class="grid2">
      <div class="fg"><label>Colaborador que recibe</label><input id="f-aafirma1" placeholder="Nombre"></div>
      <div class="fg"><label>Supervisor</label><input id="f-aafirma2" placeholder="Nombre"></div>
      <div class="fg"><label>Quien emite el acta</label><input id="f-aafirma3" placeholder="Nombre"></div>
      <div class="fg"><label>Testigo (opcional)</label><input id="f-aafirma4" placeholder="Nombre"></div>
    </div>`;
    h+=`<div class="sec-title">ğŸ“ Anexos</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b></div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;
  } else if(newDocType==='baja'){
    h+=`<div class="sec-title">ğŸšª Baja de Personal</div>
    <div class="grid2">
      <div class="fg"><label>Folio</label><input id="f-bfolio" value="EC-BAJ-${String(loadDocs().filter(d=>d.type==='baja').length+1).padStart(3,'0')}"></div>
      <div class="fg"><label>Fecha <span class="req">*</span></label><input type="date" id="f-bfecha"></div>
      <div class="fg"><label>Colaborador <span class="req">*</span></label><input id="f-bcolaborador" placeholder="Nombre del colaborador"></div>
      <div class="fg"><label>Puesto</label><input id="f-bpuesto" placeholder="Puesto"></div>
      <div class="fg"><label>Ãrea</label><select id="f-barea"><option>Celula Atlixco</option><option>Celula Neza</option><option>Administrativos</option><option>Operacion de ventas</option><option>Mineria</option><option>Control documental</option><option>Coordinacion</option><option>Supervision</option></select></div>
      <div class="fg"><label>Fecha de Ingreso</label><input type="date" id="f-bingreso"></div>
      <div class="fg"><label>Ãšltimo DÃ­a Laborado</label><input type="date" id="f-bultimo"></div>
      <div class="fg"><label>Sueldo diario</label><input type="number" id="f-bsueldo" placeholder="$0.00" onchange="calcularFiniquito()"></div>
    </div>
    <div class="fg"><label>Tipo de Baja</label><select id="f-btipo"><option>Renuncia voluntaria</option><option>RescisiÃ³n de contrato</option><option>TÃ©rmino de contrato</option><option>Abandono de trabajo</option><option>JubilaciÃ³n</option></select></div>
    <div class="fg"><label>Motivo de la Baja</label><textarea id="f-bmotivo" rows="3" placeholder="Motivo de la baja..."></textarea></div>
    <div class="fg"><label>Observaciones</label><textarea id="f-bobs" rows="2" placeholder="Observaciones adicionales..."></textarea></div>
    <div class="fg"><label>Entrega de Equipo/Materiales</label><textarea id="f-bentrega" rows="2" placeholder="Lista de equipo entregado..."></textarea></div>
    
    <div class="sec-title">ğŸ’° CÃ¡lculo de Finiquito</div>
    <div style="background:#f8f9fa;padding:16px;border-radius:8px">
      <div class="grid2">
        <div class="fg"><label>DÃ­as laborados adeudados</label><input type="number" id="f-bdias" value="0" onchange="calcularFiniquito()"></div>
        <div class="fg"><label>Monto dÃ­as ($)</label><input id="f-bdiasmon" readonly style="background:#e9ecef"></div>
        <div class="fg"><label>Proporcional vacaciones (dÃ­as)</label><input type="number" id="f-bvacaciones" value="0" onchange="calcularFiniquito()"></div>
        <div class="fg"><label>Monto vacaciones ($)</label><input id="f-bvacmon" readonly style="background:#e9ecef"></div>
        <div class="fg"><label>Proporcional aguinaldo (dÃ­as)</label><input type="number" id="f-baguinaldo" value="0" onchange="calcularFiniquito()"></div>
        <div class="fg"><label>Monto aguinaldo ($)</label><input id="f-baguimon" readonly style="background:#e9ecef"></div>
        <div class="fg"><label>Prima vacacional (%)</label><input type="number" id="f-bprima" value="25" onchange="calcularFiniquito()"></div>
        <div class="fg"><label>Monto prima ($)</label><input id="f-bprimamon" readonly style="background:#e9ecef"></div>
        <div class="fg"><label>Comisiones pendientes ($)</label><input type="number" id="f-bcomisiones" value="0" onchange="calcularFiniquito()"></div>
        <div class="fg"><label>Otros conceptos ($)</label><input type="number" id="f-botros" value="0" onchange="calcularFiniquito()"></div>
      </div>
      <div style="margin-top:12px;padding:12px;background:var(--lt);border-radius:8px;text-align:center">
        <div style="font-size:12px;color:var(--muted)">TOTAL FINIQUITO</div>
        <div style="font-size:28px;font-weight:700;color:var(--dk)" id="f-btotal">$0.00</div>
      </div>
    </div>
    
    <div class="sec-title">âœ… Estatus de Pago</div>
    <div class="fg">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
        <input type="checkbox" id="f-bpagado" style="width:20px;height:20px">
        <span>Finiquito pagado</span>
      </label>
    </div>
    <div class="grid2">
      <div class="fg"><label>Fecha de pago</label><input type="date" id="f-bfechapago"></div>
      <div class="fg"><label>MÃ©todo de pago</label><select id="f-bmetodo"><option>Transferencia</option><option>Efectivo</option><option>Cheque</option></select></div>
    </div>
    
    <div class="sec-title">ğŸ“„ Documentos de Baja</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('docs-baja-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ“„</div>
        <div class="upload-text"><b>Clic para subir documentos firmados</b></div>
        <div style="font-size:11px;color:var(--muted)">Renuncia, finiquito firmado, etc.</div>
      </div>
      <input type="file" id="docs-baja-input" accept="image/*,.pdf" multiple style="display:none" onchange="handleDocsBaja(this)">
      <div id="docs-baja-preview"></div>
    </div>`;
    h+=`<div class="sec-title">ğŸ“ Anexos adicionales</div>
    <div class="fg">
      <div class="upload-zone" onclick="document.getElementById('anexos-input').click()" style="margin-bottom:10px">
        <div class="upload-icon">ğŸ–¼ï¸</div>
        <div class="upload-text"><b>Clic para agregar imÃ¡genes</b></div>
      </div>
      <input type="file" id="anexos-input" accept="image/*" multiple style="display:none" onchange="handleAnexos(this)">
      <div id="anexos-preview"></div>
    </div>
    <div class="fg"><label>Tabla o texto adicional</label><textarea id="f-tabla" rows="4" placeholder="Pega aquÃ­ tablas de Excel o texto adicional..."></textarea></div>`;
    h+=`<div class="sec-title">âœï¸ Firmas</div><div id="tbl-firmasB"></div>`;
  }

  h+=`<div style="padding:20px 0;display:flex;gap:12px;justify-content:center;flex-wrap:wrap">
    <button class="btn btn-pri" onclick="saveAndDownload('pdf')" style="padding:14px 32px;font-size:15px">ğŸ“• Guardar y Descargar PDF</button>
    <button class="btn" style="padding:14px 32px;font-size:15px;background:linear-gradient(135deg,#1a5fa8,#2b7fd4);color:#fff" onclick="saveAndDownload('word')">ğŸ“„ Guardar y Descargar Word</button>
    <button class="btn btn-ghost" onclick="saveAndDownload('save')" style="padding:14px 32px;font-size:15px">ğŸ’¾ Solo Guardar</button>
  </div>`;

  fa.innerHTML=h;
  // Render dynamic tables after DOM update
  setTimeout(()=>{
    if(newDocType==='minuta'){
      renderMiniTable('tbl-asist',[{key:'nombre',label:'Nombre',ph:'Nombre completo'},{key:'cargo',label:'Cargo',ph:'Cargo/Ãrea'},{key:'asistencia',label:'Asist.',type:'select',opts:['Presente','Ausente','Justificado']}],formAsistentes,'formAsistentes');
      renderMiniTable('tbl-orden',[{key:'horario',label:'Horario',ph:'HH:MM'},{key:'tema',label:'Tema',ph:'DescripciÃ³n'},{key:'responsable',label:'Resp.',ph:'Nombre'}],formOrden,'formOrden');
      renderMiniTable('tbl-desarrollo',[{key:'tema',label:'Tema',ph:'Tema'},{key:'descripcion',label:'Resumen',ph:'Puntos clave...'},{key:'decision',label:'DecisiÃ³n',ph:'DecisiÃ³n'}],formDesarrollo,'formDesarrollo');
      renderMiniTable('tbl-acuerdos',[{key:'compromiso',label:'Compromiso',ph:'DescripciÃ³n'},{key:'responsable',label:'Resp.',ph:'Nombre'},{key:'fecha',label:'Fecha',type:'date'},{key:'prioridad',label:'Prior.',type:'select',opts:['Alta','Media','Baja']},{key:'estatus',label:'Estatus',type:'select',opts:['Pendiente','En proceso','Completado']}],formAcuerdos,'formAcuerdos');
      renderMiniTable('tbl-firmasM',[{key:'nombre',label:'Nombre',ph:'Nombre'},{key:'cargo',label:'Cargo',ph:'Cargo'}],formFirmasM,'formFirmasM');
    } else if(newDocType==='aviso'){
      renderMiniTable('tbl-acciones',[{key:'accion',label:'AcciÃ³n',ph:'DescripciÃ³n'},{key:'responsable',label:'Resp.',ph:'Nombre/Ãrea'},{key:'fecha',label:'Fecha',type:'date'}],formAcciones,'formAcciones');
      renderMiniTable('tbl-firmasA',[{key:'nombre',label:'Nombre',ph:'Nombre'},{key:'cargo',label:'Cargo',ph:'Cargo'}],formFirmasA,'formFirmasA');
    } else if(newDocType==='retroalimentacion'){
      renderMiniTable('tbl-firmasR',[{key:'nombre',label:'Nombre',ph:'Nombre'},{key:'cargo',label:'Cargo',ph:'Cargo'}],formFirmasR,'formFirmasR');
    } else if(newDocType==='plantrabajo'){
      renderMiniTable('tbl-firmasP',[{key:'nombre',label:'Nombre',ph:'Nombre'},{key:'cargo',label:'Cargo',ph:'Cargo'}],formFirmasP,'formFirmasP');
    } else if(newDocType==='baja'){
      renderMiniTable('tbl-firmasB',[{key:'nombre',label:'Nombre',ph:'Nombre'},{key:'cargo',label:'Cargo',ph:'Cargo'}],formFirmasB,'formFirmasB');
    }
  },0);
}

function renderMiniTable(containerId, cols, data, ref){
  const c=document.getElementById(containerId); if(!c)return;
  let h=`<table class="mini-tbl"><thead><tr><th>#</th>`;
  cols.forEach(col=>h+=`<th>${col.label}</th>`);
  h+='<th></th></tr></thead><tbody>';
  data.forEach((row,i)=>{
    h+=`<tr><td style="text-align:center;color:var(--muted);font-weight:600;width:28px">${i+1}</td>`;
    cols.forEach(col=>{
      if(col.type==='select'){
        h+='<td><select onchange="updateFormRow(\''+ref+'\','+i+',\''+col.key+'\',this.value)">';
        col.opts.forEach(o=>h+=`<option${row[col.key]===o?' selected':''}>${o}</option>`);
        h+='</select></td>';
      } else if(col.type==='date'){
        h+=`<td><input type="date" value="${row[col.key]||''}" onchange="updateFormRow('${ref}',${i},'${col.key}',this.value)"></td>`;
      } else if(col.type==='time'){
        h+=`<td><input type="time" value="${row[col.key]||''}" onchange="updateFormRow('${ref}',${i},'${col.key}',this.value)"></td>`;
      } else {
        h+=`<td><input value="${row[col.key]||''}" placeholder="${col.ph||''}" oninput="updateFormRow('${ref}',${i},'${col.key}',this.value)"></td>`;
      }
    });
    h+=`<td style="width:28px;text-align:center"><button class="btn-rm" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px" onclick="removeFormRow('${ref}',${i},'${containerId}','${btoa(JSON.stringify(cols))}')"${data.length<=1?' disabled style="opacity:.3"':''}>âœ•</button></td></tr>`;
  });
  h+=`</tbody></table><button class="btn-add-row" onclick="addFormRow('${ref}','${containerId}','${btoa(JSON.stringify(cols))}')">+ Agregar</button>`;
  c.innerHTML=h;
}

function getFormRef(ref){
  const m={formAsistentes,formOrden,formDesarrollo,formAcuerdos,formFirmasM,formAcciones,formFirmasA,formFirmasR,formFirmasP,formFirmasB};
  return m[ref];
}
function updateFormRow(ref,i,k,v){getFormRef(ref)[i][k]=v;}
function addFormRow(ref,cid,colsB64){
  const d=getFormRef(ref);const keys=Object.keys(d[0]);const nr={};keys.forEach(k=>nr[k]='');d.push(nr);
  const cols=JSON.parse(atob(colsB64));renderMiniTable(cid,cols,d,ref);
}
function removeFormRow(ref,i,cid,colsB64){
  const d=getFormRef(ref);if(d.length>1){d.splice(i,1);const cols=JSON.parse(atob(colsB64));renderMiniTable(cid,cols,d,ref);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAVE DOCUMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function V(id){return document.getElementById(id)?.value||'';}
function fmtDate(d){if(!d)return'â€”';const p=d.split('-');return p.length===3?`${p[2]}/${p[1]}/${p[0]}`:d;}

function collectDocData(){
  const anexos = anexosData.slice();
  const tabla = V('f-tabla');
  
  if(newDocType==='minuta'){
    return {
      type:'minuta', folio:V('f-folio'), title:`Minuta ${V('f-tipo')} â€“ ${fmtDate(V('f-fecha'))}`,
      displayDate:fmtDate(V('f-fecha')), status:'pendiente',
      data:{tipo:V('f-tipo'),fecha:V('f-fecha'),hinicio:V('f-hinicio'),hfin:V('f-hfin'),
        ubicacion:V('f-ubicacion'),convoca:V('f-convoca'),elabora:V('f-elabora'),objetivo:V('f-objetivo'),
        descripcion:V('f-descripcion'),
        asistentes:formAsistentes.filter(a=>a.nombre),orden:formOrden.filter(o=>o.tema),
        desarrollo:formDesarrollo.filter(d=>d.tema),acuerdos:formAcuerdos.filter(a=>a.compromiso),
        proxReunion:{fecha:V('f-proxfecha'),hora:V('f-proxhora'),lugar:V('f-proxlugar'),temas:V('f-proxtemas')},
        observaciones:V('f-obs'),firmas:formFirmasM.filter(f=>f.nombre),
        anexos:anexos,tabla:tabla}
    };
  } else if(newDocType==='aviso'){
    return {
      type:'aviso', folio:V('f-afolio'), title:V('f-aasunto')||'Aviso sin tÃ­tulo',
      displayDate:fmtDate(V('f-afecha')), status:'pendiente',
      data:{tipo:V('f-atipo'),fecha:V('f-afecha'),vigencia:V('f-avigencia'),
        emitido:V('f-aemitido'),dirigido:V('f-adirigido'),prioridad:V('f-aprioridad'),
        asunto:V('f-aasunto'),contenido:V('f-acontenido'),contacto:V('f-acontacto'),
        acciones:formAcciones.filter(a=>a.accion),firmas:formFirmasA.filter(f=>f.nombre),
        anexos:anexos,tabla:tabla}
    };
  } else if(newDocType==='retroalimentacion'){
    const tipoRetro = V('f-rtipo');
    let evalData = null;
    if(tipoRetro === 'EvaluaciÃ³n de llamada'){
      evalData = {
        tiempoLlamada: V('f-rtiempollamada'),
        numero: V('f-rnumero'),
        tipificacion: V('f-rtipificacion'),
        saludo: parseInt(V('f-eval-saludo'))||0,
        tono: parseInt(V('f-eval-tono'))||0,
        sondeo: parseInt(V('f-eval-sondeo'))||0,
        objeciones: parseInt(V('f-eval-objeciones'))||0,
        cierre: parseInt(V('f-eval-cierre'))||0,
        valorizacion: parseInt(V('f-eval-valorizacion'))||0,
        monetizacion: parseInt(V('f-eval-monetizacion'))||0,
        producto: parseInt(V('f-eval-producto'))||0,
        fluidez: parseInt(V('f-eval-fluidez'))||0,
        total: calcularEval()
      };
    }
    return {
      type:'retroalimentacion', folio:V('f-rfolio'), title:`RetroalimentaciÃ³n â€“ ${V('f-rcolaborador')}`,
      displayDate:fmtDate(V('f-rfecha')), status:'pendiente',
      data:{fecha:V('f-rfecha'),colaborador:V('f-rcolaborador'),puesto:V('f-rpuesto'),
        area:V('f-rarea'),supervisor:V('f-rsupervisor'),tipo:tipoRetro,
        motivo:V('f-rmotivo'),contenido:V('f-rcontenido'),compromisos:V('f-rcompromisos'),seguimiento:V('f-rseguimiento'),
        evaluacionLlamada: evalData,
        firmas:formFirmasR.filter(f=>f.nombre),
        anexos:anexos,tabla:tabla}
    };
  } else if(newDocType==='plantrabajo'){
    return {
      type:'plantrabajo', folio:V('f-pfolio'), title:`Plan de Trabajo â€“ ${V('f-pcolaborador')}`,
      displayDate:fmtDate(V('f-pfecha')), status:'pendiente',
      data:{fecha:V('f-pfecha'),colaborador:V('f-pcolaborador'),puesto:V('f-ppuesto'),
        area:V('f-parea'),supervisor:V('f-psupervisor'),periodo:V('f-pperiodo'),
        objetivo:V('f-pobjetivo'),actividades:V('f-pactividades'),indicadores:V('f-pindicadores'),revision:V('f-prevision'),
        firmas:formFirmasP.filter(f=>f.nombre),
        anexos:anexos,tabla:tabla}
    };
  } else if(newDocType==='actaadmin'){
    return {
      type:'actaadmin', folio:V('f-aafolio'), title:`Acta Administrativa â€“ ${V('f-aacolaborador')}`,
      displayDate:fmtDate(V('f-aafecha')), status:'pendiente',
      data:{fecha:V('f-aafecha'),colaborador:V('f-aacolaborador'),puesto:V('f-aapuesto'),
        area:V('f-aaarea'),antiguedad:V('f-aaantiguedad'),tipoFalta:V('f-aatipo'),numero:V('f-aanumero'),
        hechos:V('f-aahechos'),fundamento:V('f-aafundamento'),sancion:V('f-aasancion'),compromiso:V('f-aacompromiso'),
        acuerdos:V('f-aaacuerdos'),fechaRevision:V('f-aarevision'),responsableSeguimiento:V('f-aaresponsable'),
        firmaColaborador:V('f-aafirma1'),firmaSupervisor:V('f-aafirma2'),firmaEmite:V('f-aafirma3'),firmaTestigo:V('f-aafirma4'),
        anexos:anexos,tabla:tabla}
    };
  } else if(newDocType==='baja'){
    const finiquito = calcularFiniquito();
    return {
      type:'baja', folio:V('f-bfolio'), title:`Baja â€“ ${V('f-bcolaborador')}`,
      displayDate:fmtDate(V('f-bfecha')), status:'pendiente',
      data:{fecha:V('f-bfecha'),colaborador:V('f-bcolaborador'),puesto:V('f-bpuesto'),
        area:V('f-barea'),ingreso:V('f-bingreso'),tipo:V('f-btipo'),ultimo:V('f-bultimo'),
        motivo:V('f-bmotivo'),observaciones:V('f-bobs'),entrega:V('f-bentrega'),
        sueldo:parseFloat(V('f-bsueldo'))||0,
        finiquito:{
          dias:parseFloat(V('f-bdias'))||0, montoDias:finiquito.montoDias,
          vacaciones:parseFloat(V('f-bvacaciones'))||0, montoVac:finiquito.montoVac,
          aguinaldo:parseFloat(V('f-baguinaldo'))||0, montoAgui:finiquito.montoAgui,
          primaPct:parseFloat(V('f-bprima'))||25, montoPrima:finiquito.montoPrima,
          comisiones:finiquito.comisiones, otros:finiquito.otros, total:finiquito.total
        },
        pagado:document.getElementById('f-bpagado')?.checked||false,
        fechaPago:V('f-bfechapago'),metodoPago:V('f-bmetodo'),
        docsBaja:docsBajaData.slice(),
        firmas:formFirmasB.filter(f=>f.nombre),
        anexos:anexos,tabla:tabla}
    };
  }
}

function saveAndDownload(mode){
  const docData=collectDocData();
  docData.id=genId();docData.createdAt=Date.now();docData.evidence=null;docData.evidenceDate=null;
  const docs=loadDocs();docs.push(docData);saveDocs(docs);
  anexosData = []; // Reset anexos after save
  docsBajaData = []; // Reset docs baja after save
  uploadToDrive(docData);
  if(mode==='pdf') generateDocPDF(docData);
  else if(mode==='word') generateDocWord(docData);
  toast('âœ… Documento guardado'+(mode!=='save'?' y descargado':''));
  setTimeout(()=>showPage('dashboard'),500);
}

// Download from history
function downloadDocPDF(id){const docs=loadDocs();const d=docs.find(x=>x.id===id);if(d)generateDocPDF(d);}
function downloadDocWord(id){const docs=loadDocs();const d=docs.find(x=>x.id===id);if(d)generateDocWord(d);}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF GENERATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateDocPDF(d){
  const{jsPDF}=window.jspdf;const doc=new jsPDF('p','mm','letter');
  const w=215.9,m=16;let y=6;
  
  // Header
  doc.setFillColor(240,247,252);doc.rect(0,0,w,26,'F');
  doc.setFillColor(220,238,251);doc.rect(0,18,w,8,'F');
  doc.setFillColor(200,225,245);doc.rect(0,22,w,4,'F');
  doc.setFontSize(15);doc.setTextColor(27,117,187);doc.setFont('helvetica','bold');doc.text('ExpertCell',16,14);
  doc.setFontSize(8);doc.setTextColor(113,128,150);doc.setFont('helvetica','normal');doc.text('Distribuidor Autorizado AT&T',w-16,14,{align:'right'});
  doc.setDrawColor(27,117,187);doc.setLineWidth(0.7);doc.line(0,26,w,26);y=32;

  const dd=d.data||{};
  const typeNames={minuta:'Minuta',aviso:'Aviso',retroalimentacion:'RetroalimentaciÃ³n',plantrabajo:'Plan de Trabajo',actaadmin:'Acta Administrativa',baja:'Baja de Personal'};
  const addFooter=(pn)=>{doc.setDrawColor(27,117,187);doc.setLineWidth(0.5);doc.line(m,279-16,w-m,279-16);doc.setFontSize(7);doc.setTextColor(113,128,150);doc.setFont('helvetica','normal');doc.text(`ExpertCell | ${typeNames[d.type]||d.type} | ${d.folio||''} | PÃ¡g ${pn}`,w/2,279-11,{align:'center'});};
  const checkPage=()=>{if(y>245){addFooter(doc.getNumberOfPages());doc.addPage();y=16;return true;}return false;};
  const sec=(title)=>{checkPage();doc.setFontSize(11);doc.setTextColor(27,117,187);doc.setFont('helvetica','bold');doc.text(title,m,y);y+=6;};
  const tblOpts={margin:{left:m,right:m},theme:'grid',styles:{fontSize:9,cellPadding:2.5,lineColor:[204,204,204],lineWidth:.3},headStyles:{fillColor:[13,79,128],textColor:255,fontStyle:'bold',fontSize:8},alternateRowStyles:{fillColor:[245,247,250]}};
  const addText=(text)=>{if(!text)return;doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','normal');const ls=doc.splitTextToSize(text,w-m*2);doc.text(ls,m,y);y+=ls.length*4.5+4;};

  if(d.type==='minuta'){
    doc.setFontSize(18);doc.setTextColor(13,79,128);doc.setFont('helvetica','bold');doc.text('MINUTA DE REUNIÃ“N',w/2,y+6,{align:'center'});
    doc.setFontSize(10);doc.setTextColor(113,128,150);doc.setFont('helvetica','normal');doc.text(`${dd.tipo||''}     Folio: ${d.folio||''}`,w/2,y+13,{align:'center'});
    doc.setDrawColor(27,117,187);doc.setLineWidth(0.5);doc.line(m,y+16,w-m,y+16);y+=24;

    sec('InformaciÃ³n de la ReuniÃ³n');
    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:38,fillColor:[232,242,250],fontStyle:'bold',textColor:[13,79,128]}},body:[
      ['Fecha:',fmtDate(dd.fecha),'Folio:',d.folio||''],
      ['Hora inicio:',dd.hinicio||'â€”','Hora tÃ©rmino:',dd.hfin||'â€”'],
      ['UbicaciÃ³n:',{content:dd.ubicacion||'â€”',colSpan:3}],
      ['Convocada por:',{content:dd.convoca||'â€”',colSpan:3}]
    ]});y=doc.lastAutoTable.finalY+6;

    if(dd.objetivo){sec('Objetivo');addText(dd.objetivo);}
    if(dd.descripcion){sec('DescripciÃ³n');addText(dd.descripcion);}
    if(dd.asistentes?.length){sec('Lista de Asistencia');doc.autoTable({startY:y,...tblOpts,head:[['#','Nombre','Cargo','Asistencia','Firma']],body:dd.asistentes.map((a,i)=>[i+1,a.nombre,a.cargo,a.asistencia,''])});y=doc.lastAutoTable.finalY+6;}
    if(dd.desarrollo?.length){sec('Desarrollo');doc.autoTable({startY:y,...tblOpts,head:[['#','Tema','DescripciÃ³n','DecisiÃ³n']],body:dd.desarrollo.map((x,i)=>[i+1,x.tema,x.descripcion,x.decision])});y=doc.lastAutoTable.finalY+6;}
    if(dd.acuerdos?.length){sec('Acuerdos y Compromisos');doc.autoTable({startY:y,...tblOpts,head:[['#','Compromiso','Responsable','Fecha','Prioridad','Estatus']],body:dd.acuerdos.map((a,i)=>[i+1,a.compromiso,a.responsable,a.fecha,a.prioridad,a.estatus])});y=doc.lastAutoTable.finalY+6;}
    if(dd.proxReunion?.fecha||dd.proxReunion?.hora){sec('PrÃ³xima ReuniÃ³n');doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:38,fillColor:[232,242,250],fontStyle:'bold',textColor:[13,79,128]}},body:[['Fecha:',fmtDate(dd.proxReunion.fecha)||'â€”'],['Hora:',dd.proxReunion.hora||'â€”'],['Lugar:',dd.proxReunion.lugar||'â€”'],['Pendientes:',dd.proxReunion.temas||'â€”']]});y=doc.lastAutoTable.finalY+6;}
    if(dd.observaciones){sec('Observaciones');addText(dd.observaciones);}
    if(dd.tabla){sec('InformaciÃ³n Adicional');addText(dd.tabla);}
    // Anexos/ImÃ¡genes
    if(dd.anexos?.length){
      sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2;
            const maxH = 80;
            let imgW = imgProps.width;
            let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio;
            imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){console.log('Error adding image:',e);}
      });
    }
    if(dd.firmas?.length){checkPage();sec('Firmas');y+=12;const sp=(w-m*2)/dd.firmas.length;dd.firmas.forEach((f,i)=>{const cx=m+sp*i+sp/2;doc.setDrawColor(74,74,74);doc.setLineWidth(.4);doc.line(cx-25,y,cx+25,y);doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','bold');doc.text(f.nombre||'',cx,y+5,{align:'center'});doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(113,128,150);doc.text(f.cargo||'',cx,y+9,{align:'center'});});}
    
  } else if(d.type==='aviso'){
    doc.setFillColor(13,79,128);doc.roundedRect(m,y,w-m*2,18,3,3,'F');
    doc.setFontSize(20);doc.setTextColor(255);doc.setFont('helvetica','bold');doc.text('AVISO INTERNO',w/2,y+10,{align:'center'});
    doc.setFontSize(9);doc.setTextColor(168,209,240);doc.text(`${dd.tipo||''}   |   Prioridad: ${dd.prioridad||''}`,w/2,y+15.5,{align:'center'});y+=24;

    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:40,fillColor:[232,242,250],fontStyle:'bold',textColor:[13,79,128]}},body:[['Folio:',d.folio||''],['Fecha:',fmtDate(dd.fecha)],['Vigencia:',dd.vigencia||'â€”'],['Emitido por:',dd.emitido||'â€”'],['Dirigido a:',dd.dirigido||'â€”']]});y=doc.lastAutoTable.finalY+6;
    if(dd.asunto){sec('Asunto');doc.setFontSize(12);doc.setTextColor(13,79,128);doc.setFont('helvetica','bold');doc.text(dd.asunto,m,y);y+=8;}
    if(dd.contenido){sec('Contenido');addText(dd.contenido);}
    if(dd.acciones?.length){sec('Acciones Requeridas');doc.autoTable({startY:y,...tblOpts,head:[['#','AcciÃ³n','Responsable','Fecha']],body:dd.acciones.map((a,i)=>[i+1,a.accion,a.responsable,a.fecha])});y=doc.lastAutoTable.finalY+6;}
    if(dd.contacto){sec('Contacto');addText(dd.contacto);}
    // Anexos para aviso
    if(dd.anexos?.length){
      sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2;
            const maxH = 80;
            let imgW = imgProps.width;
            let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio;
            imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){console.log('Error adding image:',e);}
      });
    }
    
  } else if(d.type==='retroalimentacion'){
    doc.setFillColor(46,125,50);doc.roundedRect(m,y,w-m*2,18,3,3,'F');
    doc.setFontSize(20);doc.setTextColor(255);doc.setFont('helvetica','bold');doc.text('RETROALIMENTACIÃ“N',w/2,y+10,{align:'center'});
    doc.setFontSize(9);doc.setTextColor(200,230,201);doc.text(`${dd.tipo||''}`,w/2,y+15.5,{align:'center'});y+=24;

    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:40,fillColor:[232,245,233],fontStyle:'bold',textColor:[27,94,32]}},body:[
      ['Folio:',d.folio||''],['Fecha:',fmtDate(dd.fecha)],['Colaborador:',dd.colaborador||''],['Puesto:',dd.puesto||''],['Ãrea:',dd.area||''],['Supervisor:',dd.supervisor||''],['Tipo:',dd.tipo||'']
    ]});y=doc.lastAutoTable.finalY+6;

    if(dd.evaluacionLlamada){
      const ev=dd.evaluacionLlamada;
      sec('Datos de la Llamada');
      doc.autoTable({startY:y,...tblOpts,body:[['Tiempo:',ev.tiempoLlamada||'â€”'],['NÃºmero:',ev.numero||'â€”'],['TipificaciÃ³n:',ev.tipificacion||'â€”']]});y=doc.lastAutoTable.finalY+6;
      sec('EvaluaciÃ³n de Calidad');
      doc.autoTable({startY:y,...tblOpts,head:[['Criterio','Puntos','MÃ¡ximo']],body:[
        ['Saludo',ev.saludo,'10'],['Tono de voz',ev.tono,'10'],['Sondeo de necesidades',ev.sondeo,'15'],
        ['Manejo de objeciones',ev.objeciones,'15'],['Cierre de venta',ev.cierre,'15'],['ValorizaciÃ³n',ev.valorizacion,'10'],
        ['MonetizaciÃ³n',ev.monetizacion,'10'],['Manejo de producto',ev.producto,'10'],['Fluidez',ev.fluidez,'5'],
        [{content:'TOTAL',styles:{fontStyle:'bold'}},{content:ev.total+'%',styles:{fontStyle:'bold'}},{content:'100%',styles:{fontStyle:'bold'}}]
      ]});y=doc.lastAutoTable.finalY+6;
    } else {
      if(dd.motivo){sec('Motivo / SituaciÃ³n');addText(dd.motivo);}
      if(dd.contenido){sec('RetroalimentaciÃ³n');addText(dd.contenido);}
      if(dd.compromisos){sec('Compromisos');addText(dd.compromisos);}
      if(dd.seguimiento){sec('Seguimiento');addText(dd.seguimiento);}
    }
    // Anexos retroalimentacion
    if(dd.anexos?.length){
      sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2; const maxH = 80;
            let imgW = imgProps.width; let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio; imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){}
      });
    }
    // Firmas retroalimentacion
    if(dd.firmas?.length){checkPage();sec('Firmas');y+=12;const sp=(w-m*2)/dd.firmas.length;dd.firmas.forEach((f,i)=>{const cx=m+sp*i+sp/2;doc.setDrawColor(74,74,74);doc.setLineWidth(.4);doc.line(cx-25,y,cx+25,y);doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','bold');doc.text(f.nombre||'',cx,y+5,{align:'center'});doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(113,128,150);doc.text(f.cargo||'',cx,y+9,{align:'center'});});}

  } else if(d.type==='plantrabajo'){
    doc.setFillColor(21,101,192);doc.roundedRect(m,y,w-m*2,18,3,3,'F');
    doc.setFontSize(20);doc.setTextColor(255);doc.setFont('helvetica','bold');doc.text('PLAN DE TRABAJO',w/2,y+10,{align:'center'});y+=24;

    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:40,fillColor:[227,242,253],fontStyle:'bold',textColor:[13,71,161]}},body:[
      ['Folio:',d.folio||''],['Fecha:',fmtDate(dd.fecha)],['Colaborador:',dd.colaborador||''],['Puesto:',dd.puesto||''],['Ãrea:',dd.area||''],['Supervisor:',dd.supervisor||''],['Periodo:',dd.periodo||'']
    ]});y=doc.lastAutoTable.finalY+6;

    if(dd.objetivo){sec('Objetivo del Plan');addText(dd.objetivo);}
    if(dd.actividades){sec('Actividades / Metas');addText(dd.actividades);}
    if(dd.indicadores){sec('Indicadores de Ã‰xito');addText(dd.indicadores);}
    if(dd.revision){sec('Fecha de RevisiÃ³n');addText(fmtDate(dd.revision));}
    // Anexos plantrabajo
    if(dd.anexos?.length){
      sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2; const maxH = 80;
            let imgW = imgProps.width; let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio; imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){}
      });
    }
    // Firmas plantrabajo
    if(dd.firmas?.length){checkPage();sec('Firmas');y+=12;const sp=(w-m*2)/dd.firmas.length;dd.firmas.forEach((f,i)=>{const cx=m+sp*i+sp/2;doc.setDrawColor(74,74,74);doc.setLineWidth(.4);doc.line(cx-25,y,cx+25,y);doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','bold');doc.text(f.nombre||'',cx,y+5,{align:'center'});doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(113,128,150);doc.text(f.cargo||'',cx,y+9,{align:'center'});});}

  } else if(d.type==='actaadmin'){
    doc.setFillColor(198,40,40);doc.roundedRect(m,y,w-m*2,18,3,3,'F');
    doc.setFontSize(20);doc.setTextColor(255);doc.setFont('helvetica','bold');doc.text('ACTA ADMINISTRATIVA',w/2,y+10,{align:'center'});
    doc.setFontSize(9);doc.setTextColor(255,205,210);doc.text(`${dd.tipoFalta||''} - ${dd.numero||''} incidencia`,w/2,y+15.5,{align:'center'});y+=24;

    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:40,fillColor:[255,235,238],fontStyle:'bold',textColor:[183,28,28]}},body:[
      ['Folio:',d.folio||''],['Fecha:',fmtDate(dd.fecha)],['Colaborador:',dd.colaborador||''],['Puesto:',dd.puesto||''],['Ãrea:',dd.area||''],['AntigÃ¼edad:',dd.antiguedad||'']
    ]});y=doc.lastAutoTable.finalY+6;

    if(dd.hechos){sec('DescripciÃ³n de los Hechos');addText(dd.hechos);}
    if(dd.fundamento){sec('Fundamento / Normativa');addText(dd.fundamento);}
    if(dd.sancion){sec('SanciÃ³n Aplicada');addText(dd.sancion);}
    if(dd.compromiso){sec('Compromiso del Colaborador');addText(dd.compromiso);}
    if(dd.acuerdos){sec('Acuerdos y Revisiones');addText(dd.acuerdos);}
    if(dd.fechaRevision){sec('Fecha de RevisiÃ³n');addText(fmtDate(dd.fechaRevision)+' - Responsable: '+(dd.responsableSeguimiento||''));}

    checkPage();sec('Firmas');y+=15;
    const firmas=[{n:dd.firmaColaborador,c:'Colaborador'},{n:dd.firmaSupervisor,c:'Supervisor'},{n:dd.firmaEmite,c:'Emite'},{n:dd.firmaTestigo,c:'Testigo'}].filter(f=>f.n);
    if(firmas.length){const sp=(w-m*2)/firmas.length;firmas.forEach((f,i)=>{const cx=m+sp*i+sp/2;doc.setDrawColor(74,74,74);doc.setLineWidth(.4);doc.line(cx-25,y,cx+25,y);doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','bold');doc.text(f.n,cx,y+5,{align:'center'});doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(113,128,150);doc.text(f.c,cx,y+9,{align:'center'});});}
    // Anexos actaadmin
    if(dd.anexos?.length){
      y+=20;sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2; const maxH = 80;
            let imgW = imgProps.width; let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio; imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){}
      });
    }

  } else if(d.type==='baja'){
    doc.setFillColor(123,31,162);doc.roundedRect(m,y,w-m*2,18,3,3,'F');
    doc.setFontSize(20);doc.setTextColor(255);doc.setFont('helvetica','bold');doc.text('BAJA DE PERSONAL',w/2,y+10,{align:'center'});
    doc.setFontSize(9);doc.setTextColor(225,190,231);doc.text(`${dd.tipo||''}`,w/2,y+15.5,{align:'center'});y+=24;

    doc.autoTable({startY:y,...tblOpts,columnStyles:{0:{cellWidth:45,fillColor:[243,229,245],fontStyle:'bold',textColor:[74,20,140]}},body:[
      ['Folio:',d.folio||''],['Fecha:',fmtDate(dd.fecha)],['Colaborador:',dd.colaborador||''],['Puesto:',dd.puesto||''],['Ãrea:',dd.area||''],
      ['Fecha ingreso:',fmtDate(dd.ingreso)],['Ãšltimo dÃ­a:',fmtDate(dd.ultimo)],['Tipo de baja:',dd.tipo||'']
    ]});y=doc.lastAutoTable.finalY+6;

    if(dd.motivo){sec('Motivo de la Baja');addText(dd.motivo);}
    if(dd.observaciones){sec('Observaciones');addText(dd.observaciones);}
    if(dd.entrega){sec('Entrega de Equipo/Materiales');addText(dd.entrega);}

    if(dd.finiquito){
      sec('CÃ¡lculo de Finiquito');
      const fin=dd.finiquito;
      doc.autoTable({startY:y,...tblOpts,head:[['Concepto','Cantidad','Monto']],body:[
        ['DÃ­as laborados adeudados',fin.dias||0,'$'+(fin.montoDias||0).toFixed(2)],
        ['Proporcional vacaciones',fin.vacaciones||0,'$'+(fin.montoVac||0).toFixed(2)],
        ['Proporcional aguinaldo',fin.aguinaldo||0,'$'+(fin.montoAgui||0).toFixed(2)],
        ['Prima vacacional',fin.primaPct+'%','$'+(fin.montoPrima||0).toFixed(2)],
        ['Comisiones pendientes','','$'+(fin.comisiones||0).toFixed(2)],
        ['Otros conceptos','','$'+(fin.otros||0).toFixed(2)],
        [{content:'TOTAL FINIQUITO',styles:{fontStyle:'bold'}},{content:'',styles:{fontStyle:'bold'}},{content:'$'+(fin.total||0).toFixed(2),styles:{fontStyle:'bold'}}]
      ]});y=doc.lastAutoTable.finalY+6;
    }

    sec('Estatus de Pago');
    doc.autoTable({startY:y,...tblOpts,body:[
      ['Pagado:',dd.pagado?'âœ… SÃ':'âŒ NO'],
      ['Fecha de pago:',dd.fechaPago?fmtDate(dd.fechaPago):'â€”'],
      ['MÃ©todo:',dd.metodoPago||'â€”']
    ]});y=doc.lastAutoTable.finalY+6;
    
    // Anexos baja
    if(dd.anexos?.length){
      sec('Anexos');
      dd.anexos.forEach((img,idx)=>{
        try{
          checkPage();
          if(img.data && img.data.startsWith('data:image')){
            const imgProps = doc.getImageProperties(img.data);
            const maxW = w - m*2; const maxH = 80;
            let imgW = imgProps.width; let imgH = imgProps.height;
            const ratio = Math.min(maxW/imgW, maxH/imgH);
            imgW *= ratio; imgH *= ratio;
            doc.addImage(img.data, 'JPEG', m, y, imgW, imgH);
            y += imgH + 4;
            doc.setFontSize(8);doc.setTextColor(113,128,150);doc.text(img.name||('Imagen '+(idx+1)),m,y);y+=6;
          }
        }catch(e){}
      });
    }
    // Firmas baja
    if(dd.firmas?.length){checkPage();sec('Firmas');y+=12;const sp=(w-m*2)/dd.firmas.length;dd.firmas.forEach((f,i)=>{const cx=m+sp*i+sp/2;doc.setDrawColor(74,74,74);doc.setLineWidth(.4);doc.line(cx-25,y,cx+25,y);doc.setFontSize(9);doc.setTextColor(74,74,74);doc.setFont('helvetica','bold');doc.text(f.nombre||'',cx,y+5,{align:'center'});doc.setFontSize(8);doc.setFont('helvetica','normal');doc.setTextColor(113,128,150);doc.text(f.cargo||'',cx,y+9,{align:'center'});});}
  }

  for(let p=1;p<=doc.getNumberOfPages();p++){doc.setPage(p);addFooter(p);}
  doc.save(`${d.folio||'documento'}_ExpertCell.pdf`);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WORD GENERATION (HTML-based .doc)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateDocWord(d){
  const dd=d.data||{};
  let html=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><style>
@page{size:letter;margin:2.5cm 2cm}body{font-family:Arial,sans-serif;color:#4A4A4A;font-size:11pt;line-height:1.4}
h1{color:#0D4F80;font-size:18pt;text-align:center;margin:0 0 4pt}h2{color:#1B75BB;font-size:12pt;margin:14pt 0 6pt}
.sub{text-align:center;font-size:10pt;color:#718096;margin:0 0 8pt}.hdr{background:#E8F2FA;padding:8pt 12pt;border-left:4pt solid #1B75BB;margin-bottom:6pt}.hdr span{font-size:14pt;color:#1B75BB;font-weight:bold}
.line{border-top:2pt solid #1B75BB;margin:6pt 0 10pt}table{width:100%;border-collapse:collapse;margin-bottom:10pt;font-size:10pt}th{background:#0D4F80;color:#fff;padding:5pt 8pt;text-align:left;font-size:9pt}td{padding:4pt 8pt;border:1pt solid #ccc}tr:nth-child(even) td{background:#F5F7FA}
.lc{background:#E8F2FA;color:#0D4F80;font-weight:bold;width:130pt}.banner{background:#0D4F80;color:#fff;text-align:center;padding:12pt;font-size:18pt;font-weight:bold;margin-bottom:10pt}.banner-s{color:#A8D1F0;font-size:9pt;margin-top:3pt}
.sec-bar{background:#1B75BB;color:#fff;padding:4pt 10pt;font-weight:bold;font-size:10pt}.contact{background:#E8F2FA;padding:6pt 10pt;border:1pt solid #C5DCF0;margin:8pt 0}
.fb{display:inline-block;width:30%;text-align:center;margin:20pt 1.5%}.fl{border-bottom:1pt solid #4A4A4A;width:80%;margin:0 auto 4pt}.fn{font-size:10pt;font-weight:bold}.fc{font-size:9pt;color:#718096}
.footer{border-top:2pt solid #1B75BB;margin-top:16pt;padding-top:4pt;text-align:center;font-size:8pt;color:#718096}
</style></head><body><div class="hdr"><span>ExpertCell</span></div>`;

  if(d.type==='minuta'){
    html+=`<h1>MINUTA DE REUNIÃ“N PRESENCIAL</h1><p class="sub">â˜‘ ${dd.tipo||''} &nbsp; Folio: ${d.folio||''}</p><div class="line"></div>`;
    html+=`<h2>1. InformaciÃ³n</h2><table><tr><td class="lc">Fecha:</td><td>${fmtDate(dd.fecha)}</td><td class="lc">Folio:</td><td>${d.folio||''}</td></tr><tr><td class="lc">Hora inicio:</td><td>${dd.hinicio||'â€”'}</td><td class="lc">Hora tÃ©rmino:</td><td>${dd.hfin||'â€”'}</td></tr><tr><td class="lc">UbicaciÃ³n:</td><td colspan="3">${dd.ubicacion||'â€”'}</td></tr><tr><td class="lc">Convocada por:</td><td colspan="3">${dd.convoca||'â€”'}</td></tr><tr><td class="lc">Objetivo:</td><td colspan="3">${dd.objetivo||'â€”'}</td></tr></table>`;
    if(dd.asistentes?.length){html+=`<h2>2. Lista de Asistencia</h2><table><tr><th>#</th><th>Nombre</th><th>Cargo</th><th>Asistencia</th><th>Firma</th></tr>`;dd.asistentes.forEach((a,i)=>html+=`<tr><td>${i+1}</td><td>${a.nombre}</td><td>${a.cargo}</td><td>${a.asistencia}</td><td></td></tr>`);html+='</table>';}
    if(dd.orden?.length){html+=`<h2>3. Orden del DÃ­a</h2><table><tr><th>Horario</th><th>Tema</th><th>Responsable</th></tr>`;dd.orden.forEach(o=>html+=`<tr><td>${o.horario}</td><td>${o.tema}</td><td>${o.responsable}</td></tr>`);html+='</table>';}
    if(dd.desarrollo?.length){html+=`<h2>4. Desarrollo</h2><table><tr><th>#</th><th>Tema</th><th>Resumen</th><th>DecisiÃ³n</th></tr>`;dd.desarrollo.forEach((x,i)=>html+=`<tr><td>${i+1}</td><td>${x.tema}</td><td>${x.descripcion}</td><td>${x.decision}</td></tr>`);html+='</table>';}
    if(dd.acuerdos?.length){html+=`<h2>5. Acuerdos</h2><table><tr><th>#</th><th>Compromiso</th><th>Resp.</th><th>Fecha</th><th>Prioridad</th><th>Estatus</th></tr>`;dd.acuerdos.forEach((a,i)=>html+=`<tr><td>${i+1}</td><td>${a.compromiso}</td><td>${a.responsable}</td><td>${a.fecha}</td><td>${a.prioridad}</td><td>${a.estatus}</td></tr>`);html+='</table>';}
    if(dd.proxReunion?.fecha){html+=`<h2>6. PrÃ³xima ReuniÃ³n</h2><table><tr><td class="lc">Fecha:</td><td>${fmtDate(dd.proxReunion.fecha)}</td></tr><tr><td class="lc">Hora:</td><td>${dd.proxReunion.hora||'â€”'}</td></tr><tr><td class="lc">Lugar:</td><td>${dd.proxReunion.lugar||'â€”'}</td></tr><tr><td class="lc">Pendientes:</td><td>${dd.proxReunion.temas||'â€”'}</td></tr></table>`;}
    if(dd.observaciones)html+=`<h2>7. Observaciones</h2><p>${dd.observaciones.replace(/\n/g,'<br>')}</p>`;
    if(dd.firmas?.length){html+=`<h2>8. Firmas</h2><div style="text-align:center;margin-top:20pt">`;dd.firmas.forEach(f=>html+=`<div class="fb"><div class="fl">&nbsp;<br>&nbsp;</div><div class="fn">${f.nombre}</div><div class="fc">${f.cargo}</div></div>`);html+='</div>';}
    html+=`<div class="footer">ExpertCell â€“ Distribuidor Autorizado AT&T | Minuta Presencial | ${d.folio||''}</div>`;
  } else {
    html+=`<div class="banner">AVISO INTERNO<div class="banner-s">â˜‘ ${dd.tipo||''}  |  Prioridad: ${dd.prioridad||''}</div></div>`;
    html+=`<table><tr><td class="lc">Folio:</td><td>${d.folio||''}</td></tr><tr><td class="lc">Fecha:</td><td>${fmtDate(dd.fecha)}</td></tr><tr><td class="lc">Vigencia:</td><td>${dd.vigencia||'â€”'}</td></tr><tr><td class="lc">Emitido por:</td><td>${dd.emitido||'â€”'}</td></tr><tr><td class="lc">Dirigido a:</td><td>${dd.dirigido||'â€”'}</td></tr><tr><td class="lc">Prioridad:</td><td>${dd.prioridad||''}</td></tr></table>`;
    if(dd.asunto)html+=`<div class="sec-bar">ASUNTO</div><p style="font-size:13pt;font-weight:bold;color:#0D4F80;padding:6pt 0">${dd.asunto}</p>`;
    if(dd.contenido)html+=`<div class="sec-bar">CONTENIDO</div><p style="padding:8pt 0">${dd.contenido.replace(/\n/g,'<br>')}</p>`;
    if(dd.acciones?.length){html+=`<div class="sec-bar">ACCIONES REQUERIDAS</div><table><tr><th>#</th><th>AcciÃ³n</th><th>Responsable</th><th>Fecha</th></tr>`;dd.acciones.forEach((a,i)=>html+=`<tr><td>${i+1}</td><td>${a.accion}</td><td>${a.responsable}</td><td>${a.fecha}</td></tr>`);html+='</table>';}
    if(dd.contacto)html+=`<div class="contact"><b>â„¹ Contacto:</b> ${dd.contacto}</div>`;
    if(dd.firmas?.length){html+=`<div style="text-align:center;margin-top:20pt">`;dd.firmas.forEach(f=>html+=`<div class="fb"><div class="fl">&nbsp;<br>&nbsp;</div><div class="fn">${f.nombre}</div><div class="fc">${f.cargo}</div></div>`);html+='</div>';}
    html+=`<div class="line"></div><p style="text-align:center;font-size:12pt;color:#0D4F80;font-weight:bold">ACUSE DE RECIBO</p><p style="text-align:center;font-size:9pt;color:#718096">Confirmo haber leÃ­do y comprendido el presente aviso.</p>`;
    html+=`<table><tr><th>#</th><th>Nombre</th><th>Cargo</th><th>Firma</th><th>Fecha</th></tr>`;for(let i=1;i<=6;i++)html+=`<tr><td>${i}</td><td></td><td></td><td></td><td></td></tr>`;html+='</table>';
    html+=`<div class="footer">ExpertCell â€“ Distribuidor Autorizado AT&T | Comunicado Interno | ${d.folio||''}</div>`;
  }
  html+='</body></html>';
  const blob=new Blob(['\ufeff'+html],{type:'application/msword'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=`${d.folio||'documento'}_ExpertCell.doc`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}

// â•â•â• SYNC FROM DRIVE â•â•â•
async function syncFromDrive(){
  const cfg = loadDriveConfig();
  if(!cfg.url || !cfg.connected) return;
  try {
    const response = await fetch(cfg.url + '?action=getAll');
    const data = await response.json();
    if(data.success && data.documents){
      // Drive is source of truth - replace local with Drive data
      const driveDocs = data.documents.map(d => {
        // Map evidenceUrl to evidence for display
        if(d.evidenceUrl && !d.evidence){
          d.evidence = d.evidenceUrl;
        }
        // Ensure status is set based on evidence
        if(d.evidenceUrl || d.evidence){
          d.status = 'firmado';
        }
        return d;
      });
      const localDocs = loadDocs();
      
      // Create map of drive docs by ID
      const driveMap = new Map(driveDocs.map(d => [d.id, d]));
      
      // Update local docs with Drive versions, keep local-only docs
      const mergedDocs = [];
      
      // First add all Drive docs (they have priority)
      driveDocs.forEach(dd => {
        mergedDocs.push(dd);
      });
      
      // Then add local docs that aren't in Drive (not yet synced)
      localDocs.forEach(ld => {
        if(!driveMap.has(ld.id)){
          mergedDocs.push(ld);
        }
      });
      
      saveDocs(mergedDocs);
      updateBadges();
      if(currentPage === 'dashboard') renderDashboard();
    }
  } catch(e) {
    console.log('Sync error:', e);
  }
}

// â•â•â• INIT â•â•â•
showPage('dashboard');
syncFromDrive();
</script>
</body>
</html>
